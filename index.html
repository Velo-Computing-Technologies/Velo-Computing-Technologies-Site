<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Velo Cloud | UmeÃ¥ Engineering</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<script type="module">
let loaded=false;
try{const mod=await import('https://esm.sh/@supabase/supabase-js@2');window.supabaseCreateClient=mod.createClient;loaded=true}catch(e){}
if(!loaded)try{const mod=await import('https://unpkg.com/@supabase/supabase-js@2/dist/module/index.js');window.supabaseCreateClient=mod.createClient;loaded=true}catch(e){}
if(!loaded)try{const mod=await import('https://cdn.skypack.dev/@supabase/supabase-js@2');window.supabaseCreateClient=mod.createClient;loaded=true}catch(e){}
window.__supabaseReady=loaded;
</script>
<style>
:root{--bg:#030305;--card:#0d0d12;--card-hover:#14141c;--primary:#3ddc84;--primary-glow:rgba(61,220,132,0.25);--primary-dim:rgba(61,220,132,0.12);--danger:#ff4b4b;--danger-dim:rgba(255,75,75,0.15);--warn:#f59e0b;--warn-dim:rgba(245,158,11,0.15);--blue:#3b82f6;--blue-dim:rgba(59,130,246,0.15);--purple:#a855f7;--purple-dim:rgba(168,85,247,0.15);--patreon:#FF424D;--patreon-dim:rgba(255,66,77,0.15);--text:#f0f0f5;--text-dim:#6b7280;--border:rgba(255,255,255,0.06);--glass:rgba(13,13,18,0.7)}
*{box-sizing:border-box;margin:0;padding:0}body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;overflow-x:hidden}
#status{font-size:.6rem;padding:6px;color:var(--primary);text-align:center;letter-spacing:3px;text-transform:uppercase;background:rgba(61,220,132,0.03);border-bottom:1px solid var(--border)}
.container{max-width:960px;margin:0 auto;padding:30px 20px}.view{display:none}.view.active{display:block}
.landing-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(61,220,132,0.08) 0%,transparent 60%),radial-gradient(ellipse 40% 50% at 80% 50%,rgba(59,130,246,0.05) 0%,transparent 50%),radial-gradient(ellipse 40% 40% at 20% 80%,rgba(168,85,247,0.04) 0%,transparent 50%)}
.grid-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(255,255,255,0.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.015) 1px,transparent 1px);background-size:60px 60px}
.landing-nav{position:relative;z-index:2;display:flex;justify-content:space-between;align-items:center;padding:24px 40px;max-width:1200px;margin:0 auto}
.landing-nav .logo{font-size:1.3rem;font-weight:900;letter-spacing:-0.5px}.landing-nav .logo span{color:var(--primary)}.landing-nav .nav-links{display:flex;gap:8px}
.landing-hero{position:relative;z-index:2;text-align:center;padding:120px 20px 60px;max-width:800px;margin:0 auto}
.landing-hero .pill{display:inline-block;padding:6px 16px;border-radius:50px;background:var(--primary-dim);color:var(--primary);font-size:.7rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:24px;border:1px solid rgba(61,220,132,0.2)}
.landing-hero h1{font-size:clamp(2.5rem,6vw,4.5rem);font-weight:900;line-height:1.05;letter-spacing:-2px;margin-bottom:20px}
.landing-hero h1 .gradient-text{background:linear-gradient(135deg,var(--primary),#22d3ee,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.landing-hero p{color:var(--text-dim);font-size:1.1rem;line-height:1.7;max-width:550px;margin:0 auto 40px}
.hero-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.landing-features{position:relative;z-index:2;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;max-width:900px;margin:60px auto 0;padding:0 20px}
.feature-card{background:var(--glass);border:1px solid var(--border);border-radius:20px;padding:28px;backdrop-filter:blur(10px);transition:border-color 0.3s,transform 0.2s}
.feature-card:hover{border-color:rgba(61,220,132,0.2);transform:translateY(-2px)}
.feature-icon{font-size:1.8rem;margin-bottom:14px}.feature-card h3{font-size:.95rem;margin-bottom:8px;font-weight:700}.feature-card p{font-size:.8rem;color:var(--text-dim);line-height:1.6}
.landing-footer{position:relative;z-index:2;text-align:center;padding:80px 20px 40px;color:var(--text-dim);font-size:.7rem}
.auth-card{background:var(--card);padding:40px;border-radius:24px;border:1px solid var(--border);max-width:420px;margin:60px auto;position:relative;z-index:2}
.auth-card h2{margin-bottom:4px;font-size:1.4rem}.auth-card .subtitle{color:var(--text-dim);font-size:.8rem;margin-bottom:24px}
.auth-toggle{margin-top:20px;text-align:center;font-size:.8rem;color:var(--text-dim)}.auth-toggle a{color:var(--primary);cursor:pointer;font-weight:600}
input,textarea,select{width:100%;padding:14px 16px;margin:6px 0;background:rgba(0,0,0,0.5);border:1px solid var(--border);color:#fff;border-radius:12px;font-size:.9rem;font-family:inherit;outline:none;transition:border 0.2s}
input:focus,textarea:focus,select:focus{border-color:var(--primary)}textarea{resize:vertical;min-height:80px}select{cursor:pointer}select option{background:#111}
.input-label{font-size:.7rem;color:var(--text-dim);margin:10px 0 2px;text-transform:uppercase;letter-spacing:1px;display:block}
.btn{padding:14px 28px;border-radius:12px;border:none;font-weight:700;cursor:pointer;font-size:.9rem;width:100%;margin-top:8px;transition:all 0.2s;font-family:inherit;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}
.btn:hover{opacity:0.9;transform:translateY(-1px)}.btn:active{transform:scale(0.98)}
.btn-primary{background:var(--primary);color:#000}.btn-primary-glow{background:var(--primary);color:#000;box-shadow:0 0 30px var(--primary-glow)}
.btn-dark{background:rgba(255,255,255,0.06);color:#fff;border:1px solid var(--border)}.btn-danger{background:var(--danger);color:#fff}.btn-warn{background:var(--warn);color:#000}.btn-blue{background:var(--blue);color:#fff}
.btn-patreon{background:var(--patreon);color:#fff}.btn-purple{background:var(--purple);color:#fff}
.btn-sm{padding:8px 16px;font-size:.75rem;width:auto;margin:0;border-radius:8px}.btn-inline{width:auto}
.btn:disabled{opacity:0.3;cursor:not-allowed;transform:none}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 0;margin-bottom:24px;border-bottom:1px solid var(--border)}
.topbar-left h1{font-size:1.3rem;font-weight:900}.topbar-left h1 span{color:var(--primary)}.topbar-right{display:flex;align-items:center;gap:12px}
.role-badge{font-size:.6rem;padding:4px 10px;border-radius:20px;font-weight:700;letter-spacing:1px;text-transform:uppercase}.role-admin{background:var(--warn-dim);color:var(--warn)}.role-client{background:var(--blue-dim);color:var(--blue)}.role-patron{background:var(--patreon-dim);color:var(--patreon)}
.tabs{display:flex;gap:4px;margin-bottom:24px;background:var(--card);padding:4px;border-radius:14px;border:1px solid var(--border);overflow-x:auto}
.tab{flex:1;padding:12px;text-align:center;border-radius:10px;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--text-dim);transition:all 0.2s;white-space:nowrap}
.tab:hover{color:var(--text)}.tab.active{background:var(--primary);color:#000}.tab-content{display:none}.tab-content.active{display:block}
.sub-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.sub-tab{padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text-dim);background:rgba(255,255,255,0.03);border:1px solid var(--border);transition:all 0.2s}
.sub-tab:hover{color:var(--text)}.sub-tab.active{background:var(--primary-dim);color:var(--primary);border-color:rgba(61,220,132,0.3)}.sub-content{display:none}.sub-content.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:12px;transition:all 0.2s}
.card:hover{background:var(--card-hover);border-color:rgba(255,255,255,0.1)}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:12px}.card-title{font-weight:700;font-size:.95rem}.card-meta{font-size:.7rem;color:var(--text-dim)}.card-body{color:var(--text-dim);font-size:.85rem;line-height:1.6}
.app-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
.app-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;text-align:center;transition:all 0.3s;position:relative;overflow:hidden}
.app-card:hover{border-color:rgba(61,220,132,0.2);transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.app-icon{font-size:2.5rem;margin-bottom:12px}.app-card h4{font-size:.9rem;margin-bottom:6px}.app-card p{font-size:.72rem;color:var(--text-dim);line-height:1.5;margin-bottom:12px}
.app-status-pill{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.6rem;font-weight:700;letter-spacing:0.5px;text-transform:uppercase}
.app-status-in_progress{background:var(--warn-dim);color:var(--warn)}.app-status-released{background:var(--primary-dim);color:var(--primary)}.app-status-beta{background:var(--purple-dim);color:var(--purple)}
.badge{font-size:.6rem;padding:3px 8px;border-radius:8px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;display:inline-block}
.badge-open,.badge-pending{background:var(--primary-dim);color:var(--primary)}.badge-in_progress,.badge-quoted{background:var(--warn-dim);color:var(--warn)}
.badge-closed,.badge-declined{background:rgba(255,255,255,0.06);color:var(--text-dim)}.badge-approved{background:var(--primary-dim);color:var(--primary)}
.badge-low{background:rgba(255,255,255,0.04);color:var(--text-dim)}.badge-normal{background:var(--blue-dim);color:var(--blue)}.badge-high{background:var(--warn-dim);color:var(--warn)}.badge-urgent{background:var(--danger-dim);color:var(--danger)}
.badge-starter{background:var(--primary-dim);color:var(--primary)}.badge-basic{background:var(--blue-dim);color:var(--blue)}.badge-advanced{background:var(--purple-dim);color:var(--purple)}.badge-enterprise{background:var(--warn-dim);color:var(--warn)}
.profile-header{display:flex;align-items:center;gap:20px;margin-bottom:30px}
.profile-avatar{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,var(--primary),#22d3ee);color:#000;flex-shrink:0;background-size:cover;background-position:center}
.profile-info h2{font-size:1.2rem}.profile-info p{color:var(--text-dim);font-size:.8rem}.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.chat-container{display:flex;flex-direction:column;height:55vh;background:var(--card);border:1px solid var(--border);border-radius:20px;overflow:hidden}
.chat-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.chat-header h3{font-size:.9rem}
.chat-online{font-size:.65rem;color:var(--primary);display:flex;align-items:center;gap:6px}
.chat-online::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--primary);display:inline-block}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:8px}
.chat-messages::-webkit-scrollbar{width:4px}.chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.chat-msg{max-width:75%;padding:12px 16px;border-radius:16px;font-size:.85rem;line-height:1.5;position:relative;word-wrap:break-word}
.chat-msg.mine{align-self:flex-end;background:var(--primary);color:#000;border-bottom-right-radius:4px}
.chat-msg.theirs{align-self:flex-start;background:rgba(255,255,255,0.06);border-bottom-left-radius:4px}
.chat-msg.encrypted{border:1px solid rgba(168,85,247,0.3)}.chat-msg.mine.encrypted{background:linear-gradient(135deg,var(--primary),#22d3ee)}
.chat-msg .msg-author{font-size:.65rem;font-weight:700;margin-bottom:4px;opacity:0.7}.chat-msg.mine .msg-author{color:#000}
.chat-msg .msg-time{font-size:.55rem;opacity:0.5;margin-top:4px;text-align:right}.chat-msg.mine .msg-time{color:#000}
.chat-input-bar{padding:14px;border-top:1px solid var(--border);display:flex;gap:10px}
.chat-input-bar input{flex:1;margin:0;background:rgba(0,0,0,0.4);border-radius:14px}.chat-input-bar button{width:auto;margin:0;padding:12px 24px;border-radius:14px}
.chat-locked{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh;color:var(--text-dim);text-align:center;gap:12px}.chat-locked-icon{font-size:3rem}
.e2e-badge{display:inline-flex;align-items:center;gap:4px;font-size:.6rem;color:var(--purple);background:var(--purple-dim);padding:3px 8px;border-radius:6px;font-weight:600}
.user-list{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow-y:auto;margin-bottom:16px}
.user-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all 0.2s}
.user-item:hover{background:rgba(255,255,255,0.06);border-color:rgba(61,220,132,0.2)}.user-item.active{background:var(--primary-dim);border-color:var(--primary)}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#22d3ee);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:800;color:#000;flex-shrink:0}
.user-name{flex:1;font-size:.85rem;font-weight:600}
.chat-actions{display:flex;gap:6px;margin-top:10px}
.toggle{position:relative;display:inline-block;width:38px;height:22px}.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#333;transition:0.3s;border-radius:22px}
.toggle-slider:before{content:"";position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;transition:0.3s;border-radius:50%}
.toggle input:checked+.toggle-slider{background:var(--primary)}.toggle input:checked+.toggle-slider:before{transform:translateX(16px)}
.empty{text-align:center;padding:40px;color:var(--text-dim)}.empty-icon{font-size:2rem;margin-bottom:10px}
.form-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}.form-section h3{margin-bottom:16px;font-size:.95rem}
.form-row{display:flex;gap:10px}.form-row>*{flex:1}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;text-align:center}
.stat-value{font-size:2rem;font-weight:800}.stat-label{color:var(--text-dim);font-size:.65rem;margin-top:4px;letter-spacing:1px;text-transform:uppercase}
.section-title{margin-bottom:12px;font-size:.75rem;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase}
.divider{height:1px;background:var(--border);margin:24px 0}.price-tag{font-size:1.1rem;font-weight:800;color:var(--primary)}
.pricing-table{width:100%;border-collapse:collapse;font-size:.8rem;margin-top:12px}
.pricing-table th{text-align:left;padding:12px;color:var(--text-dim);border-bottom:1px solid var(--border);font-size:.65rem;letter-spacing:1px;text-transform:uppercase}
.pricing-table td{padding:12px;border-bottom:1px solid var(--border)}.pricing-table tr:hover td{background:var(--card-hover)}
.pricing-highlight{color:var(--primary);font-weight:700}
.rules-list{font-size:.82rem;color:var(--text-dim);line-height:1.8;padding-left:20px}.rules-list li{margin-bottom:6px}
.home-bar{position:fixed;bottom:0;left:0;right:0;z-index:100;background:var(--card);border-top:1px solid var(--border);padding:10px 20px;display:flex;justify-content:center;gap:10px;backdrop-filter:blur(20px)}
.tier-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:16px}
.tier-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px;text-align:center;transition:all 0.3s;position:relative}
.tier-card:hover{border-color:rgba(255,66,77,0.3);transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.tier-card.featured{border-color:rgba(255,66,77,0.3);box-shadow:0 0 40px rgba(255,66,77,0.08)}
.tier-card .tier-badge{position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--patreon);color:#fff;padding:3px 12px;border-radius:20px;font-size:.6rem;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.tier-price{font-size:1.8rem;font-weight:900;margin:12px 0 4px}.tier-price span{font-size:.75rem;font-weight:400;color:var(--text-dim)}
.tier-name{font-size:.95rem;font-weight:700;margin-bottom:12px}
.tier-features{list-style:none;text-align:left;font-size:.75rem;color:var(--text-dim);line-height:2;padding:0}
.tier-features li::before{content:'\2713  ';color:var(--primary);font-weight:700}
.patreon-banner{background:linear-gradient(135deg,rgba(255,66,77,0.1),rgba(255,66,77,0.03));border:1px solid rgba(255,66,77,0.2);border-radius:16px;padding:20px;margin-bottom:24px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.patreon-banner-icon{font-size:2rem}.patreon-banner-text{flex:1;min-width:200px}.patreon-banner-text h4{font-size:.9rem;margin-bottom:4px}.patreon-banner-text p{font-size:.75rem;color:var(--text-dim)}
.locked-overlay{position:relative}.locked-overlay::after{content:'ğŸ”’ Upgrade to unlock';position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(3,3,5,0.85);display:flex;align-items:center;justify-content:center;border-radius:16px;font-size:.85rem;font-weight:700;color:var(--patreon);z-index:5;cursor:pointer}
.feature-gate{padding:16px;border:1px dashed rgba(255,66,77,0.3);border-radius:12px;text-align:center;color:var(--text-dim);font-size:.8rem;margin:12px 0}
.feature-gate .gate-icon{font-size:1.5rem;margin-bottom:8px}
.editor-container{display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid var(--border);border-radius:16px;overflow:hidden;height:60vh}
.editor-panes{display:flex;flex-direction:column;overflow:hidden}
.editor-tabs{display:flex;background:rgba(0,0,0,0.4);border-bottom:1px solid var(--border)}
.editor-tab{padding:10px 16px;font-size:.75rem;font-weight:600;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:all 0.2s}
.editor-tab:hover{color:var(--text)}.editor-tab.active{color:var(--primary);border-bottom-color:var(--primary)}
.editor-area{flex:1;overflow:hidden}.editor-area textarea{width:100%;height:100%;background:#0a0a0e;color:#e0e0e0;border:none;border-radius:0;padding:16px;font-family:'JetBrains Mono',monospace;font-size:.8rem;line-height:1.6;resize:none;margin:0;outline:none;tab-size:2}
.preview-frame{background:#fff;border:none;width:100%;height:100%}
.site-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:12px;transition:all 0.2s}
.site-card:hover{border-color:rgba(61,220,132,0.2)}
@media(max-width:768px){.editor-container{grid-template-columns:1fr;height:auto}.editor-panes{height:40vh}.preview-frame{height:40vh}}
@media(max-width:600px){.form-row{flex-direction:column}.topbar{flex-direction:column;gap:10px;text-align:center}.topbar-right{justify-content:center;flex-wrap:wrap}.landing-hero h1{letter-spacing:-1px}.landing-nav{padding:16px 20px}.profile-header{flex-direction:column;text-align:center}.profile-grid{grid-template-columns:1fr}.chat-msg{max-width:88%}.app-grid{grid-template-columns:1fr 1fr}.tier-grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div id="status">INITIALIZING SYSTEM...</div>
<div id="home-bar" class="home-bar" style="display:none">
<button onclick="router('landing')" class="btn btn-dark btn-sm btn-inline">ğŸ  Home</button>
<button onclick="router('dashboard')" class="btn btn-primary btn-sm btn-inline">ğŸ“Š Dashboard</button>
<button onclick="handleLogout()" class="btn btn-danger btn-sm btn-inline">Sign Out</button>
</div>

<!-- LANDING -->
<div id="view-landing" class="view active"><div class="landing-bg"></div><div class="grid-overlay"></div>
<nav class="landing-nav"><div class="logo">VELO<span>.CLOUD</span></div><div class="nav-links" id="landing-nav-links"><button onclick="router('login')" class="btn btn-dark btn-sm btn-inline">Sign In</button><button onclick="router('signup')" class="btn btn-primary btn-sm btn-inline">Get Started</button></div></nav>
<div class="landing-hero"><div class="pill">âš¡ UmeÃ¥ Engineering Node</div><h1>Build faster.<br><span class="gradient-text">Ship smarter.</span></h1><p>Native Android, iOS & Web engineering platform. Manage projects, track tickets, and collaborate â€” all from one secure cloud portal.</p>
<div class="hero-buttons"><button onclick="router('signup')" class="btn btn-primary-glow btn-inline" style="width:auto;padding:16px 40px" id="hero-cta">Start Free â†’</button><button onclick="router('login')" class="btn btn-dark btn-inline" style="width:auto;padding:16px 40px" id="hero-login">Client Login</button></div></div>
<div class="landing-features">
<div class="feature-card"><div class="feature-icon">ğŸ«</div><h3>Ticket System</h3><p>Submit and track support tickets with priority levels.</p></div>
<div class="feature-card"><div class="feature-icon">ğŸ“±</div><h3>App Development</h3><p>Web, Android & iOS. Request custom apps instantly.</p></div>
<div class="feature-card"><div class="feature-icon">ğŸŒ</div><h3>Website Builder</h3><p>Create & deploy websites with HTML, CSS & JS. Live preview.</p></div>
<div class="feature-card"><div class="feature-icon">ğŸ”</div><h3>Encrypted Chat</h3><p>Private E2E encrypted messaging with controls.</p></div>
</div>
<div style="position:relative;z-index:2;max-width:960px;margin:60px auto 0;padding:0 20px"><div style="text-align:center;margin-bottom:24px"><h2 style="font-size:1.8rem;font-weight:900;margin-bottom:8px">ğŸ‰ Become a <span style="color:var(--patreon)">Patron</span></h2><p style="color:var(--text-dim);font-size:.9rem">Unlock premium perks, ad-free apps, developer tools, and more.</p></div>
<div class="tier-grid">
<div class="tier-card"><div class="tier-price">25<span> SEK/mo</span></div><div class="tier-name">ğŸŒ± Starter</div><ul class="tier-features"><li>Request apps for free</li><li>Basic dev tools</li><li>Save progress & favourites</li><li>1 website (subdomain)</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:16px">Join Starter</a></div>
<div class="tier-card featured"><div class="tier-badge">Popular</div><div class="tier-price">50<span> SEK/mo</span></div><div class="tier-name">âš¡ Basic</div><ul class="tier-features"><li>ALL apps ad-free</li><li>Premium FREE on 1 app</li><li>3 websites (subdomain)</li><li>Live preview editor</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:16px">Join Basic</a></div>
<div class="tier-card"><div class="tier-price">100<span> SEK/mo</span></div><div class="tier-name">ğŸš€ Advanced</div><ul class="tier-features"><li>All in Basic +</li><li>Premium on all apps</li><li>OAuth 2.0 access</li><li>10 websites (subdomain)</li><li>Make websites public</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:16px">Join Advanced</a></div>
<div class="tier-card"><div class="tier-price">200<span> SEK/mo</span></div><div class="tier-name">ğŸ’ Enterprise</div><ul class="tier-features"><li>All in Advanced +</li><li>Unlimited websites</li><li>Custom domains</li><li>App source code</li><li>IAP & Ads</li><li>Social logins & OAuth flows</li><li>High-priority tickets</li><li>FREE custom domain forever</li><li>Public apps & sites</li><li>Google Workspace Essentials</li><li>Zoho Mail Free plan</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:16px">Join Enterprise</a></div>
</div></div>
<div class="landing-footer" style="padding-bottom:80px"><p>VELO.CLOUD â€” UmeÃ¥, Sweden â€¢ Built with Supabase</p></div>
</div>

<!-- LOGIN -->
<div id="view-login" class="view"><div class="landing-bg"></div><div class="auth-card"><h2>Welcome back</h2><p class="subtitle">Sign in to your Velo Cloud portal</p><input type="email" id="login-email" placeholder="Email address"><input type="password" id="login-pass" placeholder="Password"><button onclick="handleLogin()" class="btn btn-primary" style="margin-top:16px">Sign In</button><div class="auth-toggle">No account? <a onclick="router('signup')">Create one</a></div><p onclick="router('landing')" style="margin-top:12px;cursor:pointer;font-size:.75rem;color:var(--text-dim);text-align:center">â† Back to home</p></div></div>

<!-- SIGNUP -->
<div id="view-signup" class="view"><div class="landing-bg"></div><div class="auth-card"><h2>Create account</h2><p class="subtitle">Join Velo Cloud â€” it's free</p><input type="text" id="signup-name" placeholder="Full name"><input type="email" id="signup-email" placeholder="Email address"><input type="password" id="signup-pass" placeholder="Password (min 6 characters)"><button onclick="handleSignup()" class="btn btn-primary" style="margin-top:16px">Create Account</button><div class="auth-toggle">Have an account? <a onclick="router('login')">Sign in</a></div><p onclick="router('landing')" style="margin-top:12px;cursor:pointer;font-size:.75rem;color:var(--text-dim);text-align:center">â† Back to home</p></div></div>

<!-- DASHBOARD -->
<div id="view-dashboard" class="view"><div class="container" style="padding-bottom:80px">
<div class="topbar"><div class="topbar-left"><h1>VELO<span>.CLOUD</span></h1></div><div class="topbar-right"><span id="dash-email" style="font-size:.8rem;color:var(--text-dim)"></span><span id="dash-role-badge" class="role-badge"></span><span id="dash-patron-badge" class="role-badge role-patron" style="display:none"></span><button onclick="router('landing')" class="btn btn-dark btn-sm">ğŸ </button><button onclick="handleLogout()" class="btn btn-danger btn-sm">Sign Out</button></div></div>

<div id="patreon-banner" class="patreon-banner">
<div class="patreon-banner-icon">ğŸ</div>
<div class="patreon-banner-text"><h4>Unlock Premium with Patreon</h4><p>Get ad-free apps, dev tools, website builder & more.</p></div>
<button onclick="connectPatreon()" class="btn btn-patreon btn-sm btn-inline">ğŸ”— Connect Patreon</button>
</div>

<div class="tabs"><div class="tab active" data-tab="overview" onclick="switchTab('overview')">Overview</div><div class="tab" data-tab="apps" onclick="switchTab('apps')">Apps</div><div class="tab" data-tab="websites" onclick="switchTab('websites')">ğŸŒ Sites</div><div class="tab" data-tab="tickets" onclick="switchTab('tickets')">Tickets</div><div class="tab" data-tab="community" onclick="switchTab('community')">Community</div><div class="tab" data-tab="chat" id="tab-chat" onclick="switchTab('chat')" style="display:none">Chat</div><div class="tab" data-tab="membership" onclick="switchTab('membership')">Membership</div><div class="tab" data-tab="profile" onclick="switchTab('profile')">Profile</div><div class="tab" data-tab="admin" id="tab-admin" onclick="switchTab('admin')" style="display:none">Admin</div></div>

<!-- OVERVIEW -->
<div id="panel-overview" class="tab-content active"><div class="stat-grid"><div class="stat-card"><div class="stat-value" id="stat-tickets">0</div><div class="stat-label">Tickets</div></div><div class="stat-card"><div class="stat-value" id="stat-open">0</div><div class="stat-label">Open</div></div><div class="stat-card"><div class="stat-value" id="stat-apps">0</div><div class="stat-label">Apps</div></div><div class="stat-card"><div class="stat-value" id="stat-sites">0</div><div class="stat-label">Sites</div></div></div><div class="section-title">Recent Tickets</div><div id="overview-tickets"></div></div>

<!-- APPS -->
<div id="panel-apps" class="tab-content">
<div class="sub-tabs"><div class="sub-tab active" onclick="switchAppPanel('catalog')">ğŸ“± Catalog</div><div class="sub-tab" onclick="switchAppPanel('request')">ğŸ›’ Request</div><div class="sub-tab" onclick="switchAppPanel('pricing')">ğŸ’° Pricing</div></div>
<div id="app-panel-catalog" class="sub-content active"><div class="section-title">App Catalog</div><div class="app-grid" id="app-catalog"></div></div>
<div id="app-panel-request" class="sub-content"><div class="form-section"><h3>ğŸ›’ Request a Custom App</h3><div id="app-request-gate"></div><input type="text" id="req-app-name" placeholder="App name"><textarea id="req-app-desc" placeholder="Describe your app idea..."></textarea><label class="input-label">Platform</label><select id="req-app-platform"><option value="web">ğŸŒ Web App</option><option value="android">ğŸ¤– Android</option><option value="ios">ğŸ iOS</option><option value="both">ğŸ“± Android + iOS</option><option value="all">ğŸŒğŸ“± All</option></select><label class="input-label">Store Display Name</label><input type="text" id="req-app-store-name" placeholder="Your brand name"><button onclick="submitAppRequest()" class="btn btn-primary" id="btn-submit-app-request">Submit Request</button></div><div class="section-title">Your Requests</div><div id="my-app-requests"></div></div>
<div id="app-panel-pricing" class="sub-content"><div class="form-section"><h3>ğŸ’° Platform Fees</h3><table class="pricing-table"><thead><tr><th>Platform</th><th>Fee</th><th>Type</th></tr></thead><tbody><tr><td>ğŸŒ Web</td><td class="pricing-highlight">Custom</td><td>Per project</td></tr><tr><td>ğŸ¤– Play</td><td class="pricing-highlight">$25</td><td>One-time</td></tr><tr><td>ğŸ App Store</td><td class="pricing-highlight">$100/yr</td><td>Annual</td></tr></tbody></table></div></div></div>

<!-- WEBSITES -->
<div id="panel-websites" class="tab-content">
<div class="sub-tabs"><div class="sub-tab active" onclick="switchSitePanel('my-sites')">ğŸŒ My Sites</div><div class="sub-tab" onclick="switchSitePanel('editor')">âœï¸ Editor</div></div>
<div id="site-panel-my-sites" class="sub-content active">
<div class="form-section">
<h3>â• Create New Website</h3>
<div id="site-limit-info" style="font-size:.75rem;color:var(--text-dim);margin-bottom:12px"></div>
<div class="form-row">
<div><label class="input-label">Site Title</label><input type="text" id="new-site-title" placeholder="My Awesome Site"></div>
<div><label class="input-label">Slug (subdomain)</label><input type="text" id="new-site-slug" placeholder="my-site" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9-]/g,'')"><div style="font-size:.65rem;color:var(--text-dim);margin-top:2px" id="slug-preview">slug.velocomputing.tech</div></div>
</div>
<div id="domain-type-section" style="display:none;margin-top:8px"><label class="input-label">Domain Type</label><select id="new-site-domain-type"><option value="subdomain">Subdomain (slug.velocomputing.tech)</option><option value="main" id="opt-main-domain">Main domain (velocomputing.tech/slug)</option></select></div>
<div id="public-toggle-section" style="margin-top:12px;display:flex;align-items:center;gap:10px"><label class="toggle"><input type="checkbox" id="new-site-public"><span class="toggle-slider"></span></label><span style="font-size:.8rem;color:var(--text-dim)">Make public</span><span id="public-gate-label" style="font-size:.65rem;color:var(--patreon);display:none">Requires Advanced+</span></div>
<button onclick="createWebsite()" class="btn btn-primary" id="btn-create-site" style="margin-top:12px">Create Website</button>
</div>
<div class="section-title">Your Websites</div>
<div id="my-sites-list"></div>
</div>
<div id="site-panel-editor" class="sub-content">
<div id="editor-no-site" class="empty"><div class="empty-icon">âœï¸</div>Select a site to edit from "My Sites"</div>
<div id="editor-wrapper" style="display:none">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
<div><h3 id="editor-site-title" style="font-size:1rem;font-weight:700"></h3><div id="editor-site-url" style="font-size:.7rem;color:var(--text-dim)"></div></div>
<div style="display:flex;gap:6px"><button onclick="saveSite()" class="btn btn-primary btn-sm">ğŸ’¾ Save</button><button onclick="previewSite()" class="btn btn-blue btn-sm">ğŸ‘ Preview</button><button onclick="deleteSite()" class="btn btn-danger btn-sm">ğŸ—‘ Delete</button></div>
</div>
<div class="editor-container">
<div class="editor-panes">
<div class="editor-tabs"><div class="editor-tab active" onclick="switchEditorTab('html')">HTML</div><div class="editor-tab" onclick="switchEditorTab('css')">CSS</div><div class="editor-tab" onclick="switchEditorTab('js')">JS</div></div>
<div class="editor-area"><textarea id="editor-html" spellcheck="false" placeholder="<!-- HTML here -->"></textarea><textarea id="editor-css" style="display:none" spellcheck="false" placeholder="/* CSS here */"></textarea><textarea id="editor-js" style="display:none" spellcheck="false" placeholder="// JavaScript here"></textarea></div>
</div>
<iframe id="preview-frame" class="preview-frame" sandbox="allow-scripts"></iframe>
</div>
</div>
</div>
</div>

<!-- TICKETS -->
<div id="panel-tickets" class="tab-content"><div class="form-section"><h3>ğŸ“ New Ticket</h3><div id="ticket-priority-gate"></div><input type="text" id="ticket-subject" placeholder="Subject"><textarea id="ticket-desc" placeholder="Describe your issue..."></textarea><div class="form-row"><select id="ticket-priority"><option value="low">Low</option><option value="normal" selected>Normal</option><option value="high">High</option><option value="urgent" id="opt-urgent" disabled>Urgent (Enterprise)</option></select><button onclick="createTicket()" class="btn btn-primary">Submit</button></div></div><div class="section-title">Your Tickets</div><div id="ticket-list"></div></div>

<!-- COMMUNITY -->
<div id="panel-community" class="tab-content"><div class="form-section"><h3>ğŸ’¬ New Post</h3><textarea id="post-content" placeholder="Share something..."></textarea><button onclick="createPost()" class="btn btn-primary">Post</button></div><div id="post-list"></div></div>

<!-- CHAT -->
<div id="panel-chat" class="tab-content">
<div id="chat-locked" class="chat-locked"><div class="chat-locked-icon">ğŸ”’</div><h3>Chat Access Required</h3><p style="color:var(--text-dim);font-size:.85rem;max-width:400px">Admin must enable chat, or subscribe to Starter+ on Patreon.</p></div>
<div id="chat-unlocked" style="display:none">
<div class="sub-tabs"><div class="sub-tab active" onclick="switchChatChannel('team')">ğŸ’¬ Team</div><div class="sub-tab" onclick="switchChatChannel('dm')">ğŸ” Private DM</div></div>
<div id="chat-dm-selector" style="display:none;margin-bottom:16px"><div class="section-title">Select User</div><div class="user-list" id="dm-user-list"></div></div>
<div class="chat-container"><div class="chat-header"><h3 id="chat-channel-title">ğŸ’¬ Team Chat</h3><div style="display:flex;align-items:center;gap:10px"><span id="chat-e2e-badge" class="e2e-badge" style="display:none">ğŸ” E2E</span><div class="chat-online">Live</div></div></div><div class="chat-messages" id="chat-messages"></div><div class="chat-input-bar"><input type="text" id="chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()"><button onclick="sendMessage()" class="btn btn-primary">Send</button></div></div>
<div id="dm-actions" style="display:none;margin-top:12px"><div class="chat-actions"><button onclick="blockUser()" class="btn btn-danger btn-sm">ğŸš« Block</button><button onclick="reportUser()" class="btn btn-warn btn-sm">âš ï¸ Report</button><button onclick="endConversation()" class="btn btn-dark btn-sm">âœ• End</button></div></div>
</div></div>

<!-- MEMBERSHIP -->
<div id="panel-membership" class="tab-content">
<div class="form-section"><h3>ğŸ Your Membership</h3><div id="membership-status"></div></div>
<div class="form-section"><h3>ğŸ”“ Feature Access</h3><div id="feature-access-table"></div></div>
<div class="form-section"><h3>ğŸ’ Membership Tiers</h3>
<div class="tier-grid">
<div class="tier-card"><div class="tier-price">25<span> SEK/mo</span></div><div class="tier-name">ğŸŒ± Starter</div><ul class="tier-features"><li>Request apps free</li><li>Basic dev tools</li><li>Save progress</li><li>1 website</li><li>Chat access</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:12px;font-size:.75rem">Join</a></div>
<div class="tier-card featured"><div class="tier-badge">Popular</div><div class="tier-price">50<span> SEK/mo</span></div><div class="tier-name">âš¡ Basic</div><ul class="tier-features"><li>All apps ad-free</li><li>Premium on 1 app</li><li>3 websites</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:12px;font-size:.75rem">Join</a></div>
<div class="tier-card"><div class="tier-price">100<span> SEK/mo</span></div><div class="tier-name">ğŸš€ Advanced</div><ul class="tier-features"><li>All in Basic +</li><li>Premium all apps</li><li>OAuth 2.0</li><li>10 websites</li><li>Public sites</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:12px;font-size:.75rem">Join</a></div>
<div class="tier-card"><div class="tier-price">200<span> SEK/mo</span></div><div class="tier-name">ğŸ’ Enterprise</div><ul class="tier-features"><li>All in Advanced +</li><li>Unlimited websites</li><li>Custom domains</li><li>Main domain access</li><li>Urgent tickets</li><li>Source code</li></ul><a href="https://www.patreon.com/c/VeloComputingTechnologies/membership" target="_blank" class="btn btn-patreon" style="margin-top:12px;font-size:.75rem">Join</a></div>
</div></div></div>

<!-- PROFILE -->
<div id="panel-profile" class="tab-content"><div class="profile-header"><div class="profile-avatar" id="profile-avatar">?</div><div class="profile-info"><h2 id="profile-display-name">â€”</h2><p id="profile-display-email">â€”</p><span id="profile-display-role" class="role-badge" style="margin-top:6px"></span><span id="profile-patron-badge" style="display:none;margin-top:6px;margin-left:6px" class="role-badge role-patron"></span></div></div><div class="form-section"><h3>âœï¸ Edit Profile</h3><label class="input-label">Full Name</label><input type="text" id="profile-name" placeholder="Your name"><label class="input-label">Avatar URL</label><input type="text" id="profile-avatar-url" placeholder="https://..."><button onclick="saveProfile()" class="btn btn-primary" style="margin-top:12px">Save</button></div><div class="form-section"><h3>ğŸ“Š Account Info</h3><div class="profile-grid"><div class="card" style="text-align:center"><div style="font-size:1.5rem;font-weight:800" id="profile-ticket-count">0</div><div style="color:var(--text-dim);font-size:.65rem;margin-top:4px">TICKETS</div></div><div class="card" style="text-align:center"><div style="font-size:1.5rem;font-weight:800" id="profile-post-count">0</div><div style="color:var(--text-dim);font-size:.65rem;margin-top:4px">POSTS</div></div></div></div></div>

<!-- ADMIN -->
<div id="panel-admin" class="tab-content"><div class="sub-tabs"><div class="sub-tab active" onclick="switchAdminPanel('users')">ğŸ‘¤ Users</div><div class="sub-tab" onclick="switchAdminPanel('requests')">ğŸ“± Requests</div><div class="sub-tab" onclick="switchAdminPanel('tickets')">ğŸ« Tickets</div><div class="sub-tab" onclick="switchAdminPanel('reports')">âš ï¸ Reports</div><div class="sub-tab" onclick="switchAdminPanel('sites')">ğŸŒ All Sites</div></div>
<div id="admin-panel-users" class="sub-content active"><div class="form-section"><h3>â• Add User</h3><div class="form-row"><div><label class="input-label">Name</label><input type="text" id="admin-new-name" placeholder="Full name"></div><div><label class="input-label">Email</label><input type="email" id="admin-new-email" placeholder="user@example.com"></div></div><div class="form-row"><div><label class="input-label">Password</label><input type="password" id="admin-new-pass" placeholder="Min 6"></div><div><label class="input-label">Role</label><select id="admin-new-role"><option value="client">Client</option><option value="admin">Admin</option></select></div></div><div style="margin-top:12px;display:flex;align-items:center;gap:10px"><label class="toggle"><input type="checkbox" id="admin-new-chat"><span class="toggle-slider"></span></label><span style="font-size:.8rem;color:var(--text-dim)">Chat</span></div><button onclick="adminCreateUser()" class="btn btn-primary" style="margin-top:12px">Create</button><div id="admin-create-status" style="font-size:.75rem;margin-top:8px"></div></div></div>
<div id="admin-panel-requests" class="sub-content"><div class="section-title">App Requests</div><div id="admin-app-requests"></div></div>
<div id="admin-panel-tickets" class="sub-content"><div class="section-title">All Tickets</div><div id="admin-ticket-list"></div></div>
<div id="admin-panel-reports" class="sub-content"><div class="section-title">Reports</div><div id="admin-reports-list"></div></div>
<div id="admin-panel-sites" class="sub-content"><div class="section-title">All Websites</div><div id="admin-sites-list"></div></div>
</div>

</div></div>

<script>
var SB_URL='https://lqkpxervwakucksrnoss.supabase.co';
var SB_KEY='sb_publishable_Sdi0YJz0IPwK9yV-0tLvCw_9IDZQhD8';
var PATREON_URL='https://www.patreon.com/c/VeloComputingTechnologies/membership';
var sb=null,currentUser=null,currentProfile=null,chatSubscription=null,currentChannel='team',selectedDmUser=null,selectedDmName='',editingSiteId=null;
var E2E_KEY='velo-e2e-2026';

// â”€â”€â”€ TIER PERMISSIONS â”€â”€â”€
var TIERS={none:{level:0,sites:0,publicSites:false,mainDomain:false,urgentTickets:false,freeRequests:false,chat:false,customDomain:false},starter:{level:1,sites:1,publicSites:false,mainDomain:false,urgentTickets:false,freeRequests:true,chat:true,customDomain:false},basic:{level:2,sites:3,publicSites:false,mainDomain:false,urgentTickets:false,freeRequests:true,chat:true,customDomain:false},advanced:{level:3,sites:10,publicSites:true,mainDomain:false,urgentTickets:false,freeRequests:true,chat:true,customDomain:false},enterprise:{level:4,sites:999,publicSites:true,mainDomain:true,urgentTickets:true,freeRequests:true,chat:true,customDomain:true}};
function getTier(){if(isAdmin())return TIERS.enterprise;var t=currentProfile&&currentProfile.patreon_tier?currentProfile.patreon_tier:'none';return TIERS[t]||TIERS.none}
function getTierName(){if(isAdmin())return'admin';return currentProfile&&currentProfile.patreon_tier?currentProfile.patreon_tier:'none'}

function e2eEncrypt(t){var r='';for(var i=0;i<t.length;i++)r+=String.fromCharCode(t.charCodeAt(i)^E2E_KEY.charCodeAt(i%E2E_KEY.length));return btoa(r)}
function e2eDecrypt(e){try{var d=atob(e);var r='';for(var i=0;i<d.length;i++)r+=String.fromCharCode(d.charCodeAt(i)^E2E_KEY.charCodeAt(i%E2E_KEY.length));return r}catch(x){return'[decryption failed]'}}
function getDmChannel(a,b){return'dm_'+[a,b].sort().join('_')}
function esc(s){var d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
function timeAgo(d){var diff=Date.now()-new Date(d).getTime(),m=Math.floor(diff/60000);if(m<1)return'just now';if(m<60)return m+'m ago';var h=Math.floor(m/60);if(h<24)return h+'h ago';return Math.floor(h/24)+'d ago'}
function formatTime(d){return new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function capitalize(s){return s?s.charAt(0).toUpperCase()+s.slice(1):''}
function router(id){document.querySelectorAll('.view').forEach(function(v){v.classList.remove('active')});var el=document.getElementById('view-'+id);if(el)el.classList.add('active');if(id==='dashboard')window.scrollTo(0,0);updateHomeBar()}
function updateHomeBar(){var bar=document.getElementById('home-bar');if(!bar)return;if(currentUser){bar.style.display='flex';var nav=document.getElementById('landing-nav-links');if(nav)nav.innerHTML='<button onclick="router(\'dashboard\')" class="btn btn-primary btn-sm btn-inline">Dashboard</button>';var cta=document.getElementById('hero-cta');if(cta){cta.textContent='Go to Dashboard \u2192';cta.onclick=function(){router('dashboard')}}var login=document.getElementById('hero-login');if(login)login.style.display='none'}else{bar.style.display='none'}}
function switchTab(n){document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.tab-content').forEach(function(p){p.classList.remove('active')});var panel=document.getElementById('panel-'+n);if(panel)panel.classList.add('active');var tab=document.querySelector('.tab[data-tab="'+n+'"]');if(tab)tab.classList.add('active');if(n==='overview')loadOverview();if(n==='apps')loadAppCatalog();if(n==='websites')loadMySites();if(n==='tickets'){loadTickets();applyTicketGates()}if(n==='community')loadPosts();if(n==='chat')initChat();if(n==='membership')loadMembership();if(n==='profile')loadProfileTab();if(n==='admin'){loadAdminAppRequests();loadAdminTickets();loadAdminReports();loadAdminSites()}}
function switchAdminPanel(n){document.querySelectorAll('#panel-admin .sub-tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('#panel-admin .sub-content').forEach(function(p){p.classList.remove('active')});var el=document.getElementById('admin-panel-'+n);if(el)el.classList.add('active');var tabs=document.querySelectorAll('#panel-admin .sub-tab');var map={users:0,requests:1,tickets:2,reports:3,sites:4};if(tabs[map[n]])tabs[map[n]].classList.add('active');if(n==='requests')loadAdminAppRequests();if(n==='tickets')loadAdminTickets();if(n==='reports')loadAdminReports();if(n==='sites')loadAdminSites()}
function switchAppPanel(n){document.querySelectorAll('#panel-apps .sub-tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('#panel-apps .sub-content').forEach(function(p){p.classList.remove('active')});var el=document.getElementById('app-panel-'+n);if(el)el.classList.add('active');var tabs=document.querySelectorAll('#panel-apps .sub-tab');var map={catalog:0,request:1,pricing:2};if(tabs[map[n]])tabs[map[n]].classList.add('active');if(n==='catalog')loadAppCatalog();if(n==='request')loadMyAppRequests()}
function switchSitePanel(n){document.querySelectorAll('#panel-websites .sub-tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('#panel-websites .sub-content').forEach(function(p){p.classList.remove('active')});var el=document.getElementById('site-panel-'+n);if(el)el.classList.add('active');var tabs=document.querySelectorAll('#panel-websites .sub-tab');var map={'my-sites':0,'editor':1};if(tabs[map[n]])tabs[map[n]].classList.add('active');if(n==='my-sites')loadMySites()}

// â”€â”€â”€ TIER GATES â”€â”€â”€
function applyTicketGates(){var tier=getTier();var urgentOpt=document.getElementById('opt-urgent');if(urgentOpt){urgentOpt.disabled=!tier.urgentTickets;urgentOpt.textContent=tier.urgentTickets?'Urgent':'Urgent (Enterprise only)'}}
function applySiteGates(){var tier=getTier();var info=document.getElementById('site-limit-info');if(info)info.innerText=isAdmin()?'Admin: Unlimited sites on any domain':'Your plan: '+capitalize(getTierName())+' \u2014 '+tier.sites+' site(s) max';var domSection=document.getElementById('domain-type-section');var mainOpt=document.getElementById('opt-main-domain');if(domSection)domSection.style.display=(tier.mainDomain||isAdmin())?'block':'none';if(mainOpt)mainOpt.disabled=!tier.mainDomain&&!isAdmin();var pubToggle=document.getElementById('new-site-public');var pubLabel=document.getElementById('public-gate-label');if(pubToggle){pubToggle.disabled=!tier.publicSites&&!isAdmin()}if(pubLabel){pubLabel.style.display=tier.publicSites||isAdmin()?'none':'inline'}var btn=document.getElementById('btn-create-site');if(btn)btn.disabled=tier.sites<1&&!isAdmin()}
function renderFeatureTable(){var tier=getTier();var tn=getTierName();var el=document.getElementById('feature-access-table');if(!el)return;var features=[{name:'Create Websites',has:tier.sites>0},{name:'Max Sites',has:true,val:tier.sites>=999?'Unlimited':tier.sites},{name:'Public Sites',has:tier.publicSites},{name:'Main Domain Access',has:tier.mainDomain},{name:'Custom Domains',has:tier.customDomain},{name:'Free App Requests',has:tier.freeRequests},{name:'Urgent Tickets',has:tier.urgentTickets},{name:'Chat Access',has:tier.chat}];el.innerHTML='<table class="pricing-table"><thead><tr><th>Feature</th><th>Your Access ('+capitalize(tn)+')</th></tr></thead><tbody>'+features.map(function(f){return'<tr><td>'+f.name+'</td><td>'+(f.val?'<span class="pricing-highlight">'+f.val+'</span>':f.has?'<span style="color:var(--primary)">\u2713</span>':'<span style="color:var(--danger)">\u2717 Upgrade</span>')+'</td></tr>'}).join('')+'</tbody></table>'}

// â”€â”€â”€ WEBSITE BUILDER â”€â”€â”€
async function loadMySites(){applySiteGates();var res=await sb.from('websites').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});var data=res.data;var c=document.getElementById('my-sites-list');if(!data||!data.length){c.innerHTML='<div class="empty"><div class="empty-icon">\uD83C\uDF10</div>No websites yet. Create one above!</div>';return}c.innerHTML=data.map(function(s){var siteUrl=s.domain_type==='main'?'velocomputing.tech/'+s.slug:s.slug+'.velocomputing.tech';return'<div class="site-card"><div class="card-header"><div><div class="card-title">\uD83C\uDF10 '+esc(s.title)+'</div><div class="card-meta">'+siteUrl+' \u2022 '+timeAgo(s.created_at)+'</div></div><div style="display:flex;gap:6px;align-items:center">'+(s.is_public?'<span class="badge badge-approved">Public</span>':'<span class="badge badge-closed">Private</span>')+'</div></div><div style="display:flex;gap:6px;margin-top:10px"><button onclick="editSite(\''+s.id+'\')" class="btn btn-primary btn-sm">\u270F\uFE0F Edit</button>'+(s.is_public?'<a href="'+SB_URL+'/functions/v1/site/site/'+s.slug+'" target="_blank" class="btn btn-blue btn-sm">\uD83D\uDD17 Visit</a>':'')+'<button onclick="toggleSitePublic(\''+s.id+'\','+!s.is_public+')" class="btn btn-dark btn-sm">'+(s.is_public?'\uD83D\uDD12 Unpublish':'\uD83C\uDF10 Publish')+'</button><button onclick="deleteSiteById(\''+s.id+'\')" class="btn btn-danger btn-sm">\uD83D\uDDD1</button></div></div>'}).join('')}
async function createWebsite(){var tier=getTier();var title=document.getElementById('new-site-title').value.trim();var slug=document.getElementById('new-site-slug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g,'');var domainType=(document.getElementById('new-site-domain-type')?.value)||'subdomain';var isPublic=document.getElementById('new-site-public').checked;if(!title||!slug)return alert('Title and slug required');if(slug.length<2)return alert('Slug must be at least 2 characters');var reserved=['www','api','app','admin','mail','ftp','cdn','dev','staging'];if(reserved.includes(slug))return alert('That slug is reserved');if(!isAdmin()){var res=await sb.from('websites').select('id',{count:'exact',head:true}).eq('user_id',currentUser.id);var count=res.count||0;if(count>=tier.sites)return alert('Site limit reached ('+tier.sites+' for '+capitalize(getTierName())+'). Upgrade on Patreon!');if(domainType==='main')return alert('Main domain access requires Enterprise tier');if(isPublic&&!tier.publicSites){isPublic=false}}var ins=await sb.from('websites').insert({user_id:currentUser.id,user_name:currentProfile?currentProfile.full_name:'',title:title,slug:slug,domain_type:domainType,is_public:isPublic,html:'<!DOCTYPE html>\n<html>\n<head>\n  <title>'+esc(title)+'</title>\n</head>\n<body>\n  <h1>Welcome to '+esc(title)+'</h1>\n  <p>Edit this site in the Velo Cloud editor.</p>\n</body>\n</html>',css:'body {\n  font-family: Inter, sans-serif;\n  margin: 0;\n  padding: 40px;\n  background: #0a0a0e;\n  color: #f0f0f5;\n}\n\nh1 {\n  font-size: 2rem;\n  margin-bottom: 12px;\n}\n\np {\n  color: #888;\n}',js:'// Your JavaScript here\nconsole.log("Site loaded!");'});if(ins.error){if(ins.error.message.includes('unique'))return alert('That slug is already taken');return alert('Error: '+ins.error.message)}document.getElementById('new-site-title').value='';document.getElementById('new-site-slug').value='';document.getElementById('new-site-public').checked=false;alert('Website created!');loadMySites()}
async function editSite(id){var res=await sb.from('websites').select('*').eq('id',id).single();if(res.error||!res.data)return alert('Site not found');var site=res.data;editingSiteId=id;document.getElementById('editor-site-title').innerText=site.title;var siteUrl=site.domain_type==='main'?'velocomputing.tech/'+site.slug:site.slug+'.velocomputing.tech';document.getElementById('editor-site-url').innerText=siteUrl;document.getElementById('editor-html').value=site.html||'';document.getElementById('editor-css').value=site.css||'';document.getElementById('editor-js').value=site.js||'';document.getElementById('editor-no-site').style.display='none';document.getElementById('editor-wrapper').style.display='block';switchSitePanel('editor');previewSite()}
function switchEditorTab(tab){document.querySelectorAll('.editor-tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.editor-area textarea').forEach(function(t){t.style.display='none'});document.getElementById('editor-'+tab).style.display='block';event.target.classList.add('active')}
function previewSite(){var html=document.getElementById('editor-html').value;var css=document.getElementById('editor-css').value;var js=document.getElementById('editor-js').value;var frame=document.getElementById('preview-frame');var doc='<!DOCTYPE html><html><head><style>'+css+'</style></head><body>'+html+'<script>'+js+'<\/script></body></html>';frame.srcdoc=doc}
async function saveSite(){if(!editingSiteId)return;var html=document.getElementById('editor-html').value;var css=document.getElementById('editor-css').value;var js=document.getElementById('editor-js').value;var res=await sb.from('websites').update({html:html,css:css,js:js,updated_at:new Date().toISOString()}).eq('id',editingSiteId);if(res.error)return alert('Error: '+res.error.message);previewSite();alert('Saved!')}
async function deleteSite(){if(!editingSiteId||!confirm('Delete this site?'))return;await sb.from('websites').delete().eq('id',editingSiteId);editingSiteId=null;document.getElementById('editor-wrapper').style.display='none';document.getElementById('editor-no-site').style.display='block';switchSitePanel('my-sites')}
async function deleteSiteById(id){if(!confirm('Delete this site?'))return;await sb.from('websites').delete().eq('id',id);if(editingSiteId===id){editingSiteId=null;document.getElementById('editor-wrapper').style.display='none';document.getElementById('editor-no-site').style.display='block'}loadMySites()}
async function toggleSitePublic(id,val){var tier=getTier();if(val&&!tier.publicSites&&!isAdmin())return alert('Public sites require Advanced+ tier');await sb.from('websites').update({is_public:val}).eq('id',id);loadMySites()}
document.getElementById('new-site-slug')?.addEventListener('input',function(){var v=this.value;document.getElementById('slug-preview').innerText=v?v+'.velocomputing.tech':'slug.velocomputing.tech'});

// â”€â”€â”€ ADMIN: SITES â”€â”€â”€
async function loadAdminSites(){if(!isAdmin())return;var res=await sb.from('websites').select('*').order('created_at',{ascending:false});var data=res.data;var c=document.getElementById('admin-sites-list');if(!data||!data.length){c.innerHTML='<div class="empty"><div class="empty-icon">\uD83C\uDF10</div>No sites</div>';return}c.innerHTML=data.map(function(s){var siteUrl=s.domain_type==='main'?'velocomputing.tech/'+s.slug:s.slug+'.velocomputing.tech';return'<div class="card"><div class="card-header"><div><div class="card-title">'+esc(s.title)+'</div><div class="card-meta">'+siteUrl+' \u2022 by '+esc(s.user_name||'Unknown')+' \u2022 '+timeAgo(s.created_at)+'</div></div><div style="display:flex;gap:6px">'+(s.is_public?'<span class="badge badge-approved">Public</span>':'<span class="badge badge-closed">Private</span>')+'<span class="badge badge-'+(s.domain_type==='main'?'enterprise':'starter')+'">'+s.domain_type+'</span></div></div><div style="display:flex;gap:6px;margin-top:8px"><button onclick="editSite(\''+s.id+'\')" class="btn btn-primary btn-sm">Edit</button>'+(s.is_public?'<a href="'+SB_URL+'/functions/v1/site/site/'+s.slug+'" target="_blank" class="btn btn-blue btn-sm">Visit</a>':'')+'<button onclick="toggleSitePublic(\''+s.id+'\','+!s.is_public+')" class="btn btn-dark btn-sm">'+(s.is_public?'Unpublish':'Publish')+'</button><button onclick="deleteSiteById(\''+s.id+'\')" class="btn btn-danger btn-sm">Delete</button></div></div>'}).join('')}

// â”€â”€â”€ CHAT â”€â”€â”€
async function switchChatChannel(ch){if(ch==='team'){currentChannel='team';selectedDmUser=null;selectedDmName='';document.getElementById('chat-dm-selector').style.display='none';document.getElementById('dm-actions').style.display='none';document.getElementById('chat-channel-title').innerText='\uD83D\uDCAC Team Chat';document.getElementById('chat-e2e-badge').style.display='none';document.getElementById('chat-input').placeholder='Type a message...';await loadMessages();subscribeToChatRealtime()}else{document.getElementById('chat-dm-selector').style.display='block';document.getElementById('dm-actions').style.display='none';await loadDmUserList();document.getElementById('chat-channel-title').innerText='\uD83D\uDD10 Private DM';document.getElementById('chat-e2e-badge').style.display='';document.getElementById('chat-input').placeholder='Select a user first...';document.getElementById('chat-messages').innerHTML='<div class="empty" style="padding:60px 20px"><div class="empty-icon">\uD83D\uDC65</div>Select a user to chat</div>'}document.querySelectorAll('#chat-unlocked > .sub-tabs .sub-tab').forEach(function(t){t.classList.remove('active')});var tabs=document.querySelectorAll('#chat-unlocked > .sub-tabs .sub-tab');if(ch==='team'&&tabs[0])tabs[0].classList.add('active');else if(tabs[1])tabs[1].classList.add('active')}
async function loadDmUserList(){var res=await sb.from('profiles').select('id,full_name,avatar_url').or('chat_enabled.eq.true,role.eq.admin').neq('id',currentUser.id);var data=res.data;var list=document.getElementById('dm-user-list');if(!data||!data.length){list.innerHTML='<div class="empty" style="padding:20px;font-size:.8rem">No users</div>';return}list.innerHTML=data.map(function(u){var i=(u.full_name||'?')[0].toUpperCase();return'<div class="user-item" onclick="selectDmUser(\''+u.id+'\',\''+esc(u.full_name||'User')+'\')"><div class="user-avatar"'+(u.avatar_url?' style="background-image:url('+u.avatar_url+');background-size:cover"':'')+'>'+(u.avatar_url?'':i)+'</div><div class="user-name">'+esc(u.full_name||'Unknown')+'</div></div>'}).join('')}
async function selectDmUser(uid,name){selectedDmUser=uid;selectedDmName=name;currentChannel=getDmChannel(currentUser.id,uid);document.querySelectorAll('.user-item').forEach(function(i){i.classList.remove('active')});if(event&&event.target)event.target.closest('.user-item')?.classList.add('active');document.getElementById('chat-channel-title').innerText='\uD83D\uDD10 '+name;document.getElementById('chat-input').placeholder='Encrypted message...';document.getElementById('dm-actions').style.display='block';await loadMessages();subscribeToChatRealtime()}
async function blockUser(){if(!selectedDmUser)return;if(!confirm('Block '+selectedDmName+'?'))return;await sb.from('reports').insert({reporter_id:currentUser.id,reported_id:selectedDmUser,reporter_name:currentProfile?.full_name||'',reported_name:selectedDmName,type:'block',channel:currentChannel});alert('Blocked.');switchChatChannel('dm')}
async function reportUser(){if(!selectedDmUser)return;var reason=prompt('Why report '+selectedDmName+'?');if(!reason)return;await sb.from('reports').insert({reporter_id:currentUser.id,reported_id:selectedDmUser,reporter_name:currentProfile?.full_name||'',reported_name:selectedDmName,type:'report',reason:reason,channel:currentChannel});alert('Reported.')}
async function endConversation(){if(!selectedDmUser||!confirm('End?'))return;selectedDmUser=null;selectedDmName='';switchChatChannel('dm')}

// â”€â”€â”€ PATREON â”€â”€â”€
async function connectPatreon(){try{var session=(await sb.auth.getSession()).data.session;var state=session?session.user.id:'anonymous';try{var res=await fetch(SB_URL+'/functions/v1/patreon-auth/login',{headers:session?{Authorization:'Bearer '+session.access_token}:{}});if(res.ok){var json=await res.json();if(json.url){window.location.href=json.url;return}}}catch(f){}var clientId='PIUc8t6C2jjPaiWqFKEWs65QrzO7-ZzR2zGH7x9N1IIVbvOFB7XWZDstWN8CSFw-';var redirectUri=encodeURIComponent('https://lqkpxervwakucksrnoss.supabase.co/functions/v1/patreon-auth/callback');var scopes=encodeURIComponent('identity identity[email] identity.memberships');window.location.href='https://www.patreon.com/oauth2/authorize?response_type=code&client_id='+clientId+'&redirect_uri='+redirectUri+'&scope='+scopes+'&state='+state}catch(e){window.open(PATREON_URL,'_blank')}}
function checkPatreonCallback(){var hash=window.location.hash;if(hash.includes('patreon_success')){var params=new URLSearchParams(hash.replace('#',''));var tier=params.get('tier');alert('Patreon connected! Tier: '+(tier||'active'));window.location.hash='';loadProfile().then(function(){setupDashboard();loadMembership()})}else if(hash.includes('patreon_error')){var params2=new URLSearchParams(hash.replace('#',''));alert('Patreon error: '+(params2.get('msg')||'Unknown'));window.location.hash=''}}
async function loadMembership(){var el=document.getElementById('membership-status');if(!currentProfile){el.innerHTML='<div class="empty"><div class="empty-icon">\uD83D\uDCA4</div>Not logged in</div>';return}if(currentProfile.patreon_connected&&currentProfile.patreon_active&&currentProfile.patreon_tier){el.innerHTML='<div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap"><div style="font-size:2.5rem">\uD83C\uDF89</div><div><div style="font-weight:800;font-size:1.1rem">Active Patron \u2014 '+capitalize(currentProfile.patreon_tier)+'</div><div style="color:var(--text-dim);font-size:.8rem">Connected via Patreon'+(currentProfile.patreon_email?' ('+esc(currentProfile.patreon_email)+')':'')+'</div></div><span class="badge badge-approved">Active</span></div>'}else{el.innerHTML='<div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap"><div style="font-size:2.5rem">\uD83D\uDCA4</div><div><div style="font-weight:700">No Active Membership</div><div style="color:var(--text-dim);font-size:.8rem">Subscribe on Patreon to unlock features</div></div></div><div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap"><a href="'+PATREON_URL+'" target="_blank" class="btn btn-patreon btn-sm btn-inline">\uD83C\uDF89 Subscribe</a><button onclick="connectPatreon()" class="btn btn-dark btn-sm btn-inline">\uD83D\uDD17 Connect Patreon</button></div>'}renderFeatureTable()}

// â”€â”€â”€ BOOTSTRAP â”€â”€â”€
async function bootstrap(){var status=document.getElementById('status');var a=0;while(!window.__supabaseReady&&a<40){await new Promise(function(r){setTimeout(r,100)});a++}if(!window.supabaseCreateClient){status.innerText="CRITICAL: CDN BLOCKED";status.style.color="#ff4b4b";return}try{sb=window.supabaseCreateClient(SB_URL,SB_KEY);status.innerText="SYSTEM ONLINE";var session=(await sb.auth.getSession()).data.session;if(session){currentUser=session.user;await loadProfile();setupDashboard();router('dashboard');loadOverview()}}catch(e){status.innerText="ERROR: "+e.message;status.style.color="#ff4b4b"}}
async function handleLogin(){var e=document.getElementById('login-email').value.trim(),p=document.getElementById('login-pass').value;if(!sb)return alert("System not ready.");if(!e||!p)return alert("Enter email and password.");var res=await sb.auth.signInWithPassword({email:e,password:p});if(res.error)alert("Login Failed: "+res.error.message);else window.location.reload()}
async function handleSignup(){var n=document.getElementById('signup-name').value.trim(),e=document.getElementById('signup-email').value.trim(),p=document.getElementById('signup-pass').value;if(!sb)return alert("Not ready.");if(!n||!e||!p)return alert("All fields required.");if(p.length<6)return alert("Password min 6 chars.");var res=await sb.auth.signUp({email:e,password:p,options:{data:{full_name:n}}});if(res.error)return alert("Signup Failed: "+res.error.message);alert("Created! Check email.");router('login')}
async function handleLogout(){if(chatSubscription)sb.removeChannel(chatSubscription);if(sb)await sb.auth.signOut();window.location.reload()}
async function loadProfile(){var res=await sb.from('profiles').select('*').eq('id',currentUser.id).single();if(res.data)currentProfile=res.data}
function isAdmin(){return currentProfile&&currentProfile.role==='admin'}
function hasChatAccess(){return isAdmin()||(currentProfile&&currentProfile.chat_enabled===true)||getTier().chat}
function setupDashboard(){document.getElementById('dash-email').innerText=currentUser.email;var b=document.getElementById('dash-role-badge');b.innerText=currentProfile?currentProfile.role||'client':'client';b.className='role-badge '+(isAdmin()?'role-admin':'role-client');if(isAdmin())document.getElementById('tab-admin').style.display='';if(hasChatAccess())document.getElementById('tab-chat').style.display='';var pb=document.getElementById('dash-patron-badge');if(currentProfile&&currentProfile.patreon_tier){pb.style.display='inline-block';pb.innerText=currentProfile.patreon_tier;document.getElementById('patreon-banner').style.display='none'}else{pb.style.display='none';document.getElementById('patreon-banner').style.display='flex'}updateHomeBar();checkPatreonCallback()}
async function loadProfileTab(){var av=document.getElementById('profile-avatar');var i=(currentProfile&&currentProfile.full_name?currentProfile.full_name:currentUser.email||'?')[0].toUpperCase();if(currentProfile&&currentProfile.avatar_url){av.style.backgroundImage='url('+currentProfile.avatar_url+')';av.innerText=''}else{av.style.backgroundImage='';av.innerText=i}document.getElementById('profile-display-name').innerText=currentProfile?currentProfile.full_name||'\u2014':'\u2014';document.getElementById('profile-display-email').innerText=currentUser.email;var rb=document.getElementById('profile-display-role');rb.innerText=currentProfile?currentProfile.role||'client':'client';rb.className='role-badge '+(isAdmin()?'role-admin':'role-client');var ppb=document.getElementById('profile-patron-badge');if(currentProfile&&currentProfile.patreon_tier){ppb.style.display='inline-block';ppb.innerText=currentProfile.patreon_tier}else{ppb.style.display='none'}document.getElementById('profile-name').value=currentProfile?currentProfile.full_name||'':'';document.getElementById('profile-avatar-url').value=currentProfile?currentProfile.avatar_url||'':'';var tc=(await sb.from('tickets').select('*',{count:'exact',head:true}).eq('user_id',currentUser.id)).count;var pc=(await sb.from('posts').select('*',{count:'exact',head:true}).eq('user_id',currentUser.id)).count;document.getElementById('profile-ticket-count').innerText=tc||0;document.getElementById('profile-post-count').innerText=pc||0}
async function saveProfile(){var f=document.getElementById('profile-name').value.trim(),a=document.getElementById('profile-avatar-url').value.trim();if(!f)return alert("Name required.");var res=await sb.from('profiles').update({full_name:f,avatar_url:a}).eq('id',currentUser.id);if(res.error)return alert("Error: "+res.error.message);await loadProfile();setupDashboard();loadProfileTab();alert("Saved!")}
async function loadOverview(){var res=await sb.from('tickets').select('*').order('created_at',{ascending:false}).limit(5);var tickets=res.data||[];var pc=(await sb.from('posts').select('*',{count:'exact',head:true})).count;var ac=(await sb.from('apps').select('*',{count:'exact',head:true})).count;var sc=(await sb.from('websites').select('*',{count:'exact',head:true}).eq('user_id',currentUser.id)).count;document.getElementById('stat-tickets').innerText=tickets.length;document.getElementById('stat-open').innerText=tickets.filter(function(t){return t.status==='open'}).length;document.getElementById('stat-apps').innerText=ac||0;document.getElementById('stat-sites').innerText=sc||0;document.getElementById('overview-tickets').innerHTML=!tickets.length?'<div class="empty"><div class="empty-icon">\uD83D\uDCED</div>No tickets yet</div>':tickets.slice(0,3).map(function(t){return ticketCard(t)}).join('')}
async function loadAppCatalog(){var res=await sb.from('apps').select('*').eq('is_public',true).order('created_at');var data=res.data;var c=document.getElementById('app-catalog');if(!data||!data.length){c.innerHTML='<div class="empty"><div class="empty-icon">\uD83D\uDCF1</div>No apps yet</div>';return}c.innerHTML=data.map(function(a){return'<div class="app-card"><div class="app-icon">'+a.icon+'</div><h4>'+esc(a.name)+'</h4><p>'+esc(a.description||'')+'</p><span class="app-status-pill app-status-'+a.status+'">'+a.status.replace('_',' ')+'</span></div>'}).join('')}
async function submitAppRequest(){var tier=getTier();if(!tier.freeRequests&&!isAdmin())return alert('App requests require Starter+ tier');var n=document.getElementById('req-app-name').value.trim(),d=document.getElementById('req-app-desc').value.trim(),p=document.getElementById('req-app-platform').value,s=document.getElementById('req-app-store-name').value.trim();if(!n)return alert("App name required.");var res=await sb.from('app_requests').insert({user_id:currentUser.id,user_name:currentProfile?currentProfile.full_name||currentUser.email:currentUser.email,app_name:n,description:d+'\n\n[Platform: '+p+']'+(s?'\n[Store: '+s+']':'')});if(res.error)return alert("Error: "+res.error.message);document.getElementById('req-app-name').value='';document.getElementById('req-app-desc').value='';document.getElementById('req-app-store-name').value='';alert("Submitted!");loadMyAppRequests()}
async function loadMyAppRequests(){var res=await sb.from('app_requests').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});var data=res.data;var c=document.getElementById('my-app-requests');if(!data||!data.length){c.innerHTML='<div class="empty"><div class="empty-icon">\uD83D\uDCCB</div>No requests</div>';return}c.innerHTML=data.map(function(r){return'<div class="card"><div class="card-header"><div><div class="card-title">'+esc(r.app_name)+'</div><div class="card-meta">'+timeAgo(r.created_at)+'</div></div><span class="badge badge-'+r.status+'">'+r.status+'</span></div>'+(r.description?'<div class="card-body">'+esc(r.description)+'</div>':'')+(r.admin_note?'<div style="margin-top:8px;padding:10px;background:var(--primary-dim);border-radius:10px;font-size:.8rem"><strong>Admin:</strong> '+esc(r.admin_note)+'</div>':'')+'</div>'}).join('')}
function ticketCard(t,admin){admin=admin||false;return'<div class="card"><div class="card-header"><div><div class="card-title">'+esc(t.subject)+'</div><div class="card-meta">'+timeAgo(t.created_at)+'</div></div><div style="display:flex;gap:6px"><span class="badge badge-'+t.priority+'">'+t.priority+'</span><span class="badge badge-'+t.status+'">'+t.status.replace('_',' ')+'</span></div></div>'+(t.description?'<div class="card-body">'+esc(t.description)+'</div>':'')+(admin?'<div style="margin-top:12px"><select onchange="updateTicketStatus(\''+t.id+'\',this.value)" style="width:auto;padding:6px 10px;font-size:.75rem"><option value="open" '+(t.status==='open'?'selected':'')+'>Open</option><option value="in_progress" '+(t.status==='in_progress'?'selected':'')+'>In Progress</option><option value="closed" '+(t.status==='closed'?'selected':'')+'>Closed</option></select></div>':'')+'</div>'}
async function loadTickets(){var res=await sb.from('tickets').select('*').order('created_at',{ascending:false});document.getElementById('ticket-list').innerHTML=!res.data||!res.data.length?'<div class="empty"><div class="empty-icon">\uD83D\uDCED</div>No tickets</div>':res.data.map(function(t){return ticketCard(t)}).join('')}
async function createTicket(){var s=document.getElementById('ticket-subject').value.trim(),d=document.getElementById('ticket-desc').value.trim(),p=document.getElementById('ticket-priority').value;if(!s)return alert("Subject required.");if(p==='urgent'&&!getTier().urgentTickets&&!isAdmin())return alert('Urgent tickets require Enterprise tier');var res=await sb.from('tickets').insert({user_id:currentUser.id,subject:s,description:d,priority:p});if(res.error)return alert("Error: "+res.error.message);document.getElementById('ticket-subject').value='';document.getElementById('ticket-desc').value='';document.getElementById('ticket-priority').value='normal';loadTickets()}
async function loadPosts(){var res=await sb.from('posts').select('*').order('created_at',{ascending:false});document.getElementById('post-list').innerHTML=!res.data||!res.data.length?'<div class="empty"><div class="empty-icon">\uD83D\uDCAC</div>No posts</div>':res.data.map(function(p){return'<div class="card"><div class="card-header"><div><div class="card-title">'+esc(p.author_name||'Anonymous')+'</div><div class="card-meta">'+timeAgo(p.created_at)+'</div></div>'+(p.user_id===currentUser.id||isAdmin()?'<button onclick="deletePost(\''+p.id+'\')" class="btn btn-danger btn-sm">\u2715</button>':'')+'</div><div class="card-body">'+esc(p.content)+'</div></div>'}).join('')}
async function createPost(){var c=document.getElementById('post-content').value.trim();if(!c)return alert("Write something!");var res=await sb.from('posts').insert({user_id:currentUser.id,author_name:currentProfile?currentProfile.full_name||currentUser.email:currentUser.email,content:c});if(res.error)return alert("Error: "+res.error.message);document.getElementById('post-content').value='';loadPosts()}
async function deletePost(id){if(!confirm("Delete?"))return;await sb.from('posts').delete().eq('id',id);loadPosts()}
async function initChat(){if(hasChatAccess()){document.getElementById('chat-locked').style.display='none';document.getElementById('chat-unlocked').style.display='block';currentChannel='team';selectedDmUser=null;selectedDmName='';var tabs=document.querySelectorAll('#chat-unlocked > .sub-tabs .sub-tab');tabs.forEach(function(t){t.classList.remove('active')});if(tabs[0])tabs[0].classList.add('active');document.getElementById('chat-dm-selector').style.display='none';document.getElementById('dm-actions').style.display='none';document.getElementById('chat-channel-title').innerText='\uD83D\uDCAC Team Chat';document.getElementById('chat-e2e-badge').style.display='none';document.getElementById('chat-input').placeholder='Type a message...';await loadMessages();subscribeToChatRealtime()}else{document.getElementById('chat-locked').style.display='flex';document.getElementById('chat-unlocked').style.display='none'}}
async function loadMessages(){var res=await sb.from('messages').select('*').eq('channel',currentChannel).order('created_at',{ascending:true}).limit(200);var data=res.data;var container=document.getElementById('chat-messages');if(!data||!data.length){container.innerHTML='<div class="empty" style="padding:60px 20px"><div class="empty-icon">'+(currentChannel.startsWith('dm_')?'\uD83D\uDD10':'\uD83D\uDCAC')+'</div>'+(currentChannel.startsWith('dm_')?'Start chatting!':'Say hello!')+'</div>';return}container.innerHTML=data.map(function(m){return chatBubble(m)}).join('');container.scrollTop=container.scrollHeight}
function chatBubble(m){var mine=m.user_id===currentUser.id;var isEnc=m.encrypted||currentChannel.startsWith('dm_');var content=isEnc?e2eDecrypt(m.content):m.content;return'<div class="chat-msg '+(mine?'mine':'theirs')+' '+(isEnc?'encrypted':'')+'">'+(mine?'':'<div class="msg-author">'+esc(m.author_name||'User')+'</div>')+'<div>'+esc(content)+'</div><div class="msg-time">'+(isEnc?'\uD83D\uDD10 ':'')+formatTime(m.created_at)+'</div></div>'}
function subscribeToChatRealtime(){if(chatSubscription)sb.removeChannel(chatSubscription);chatSubscription=sb.channel('chat-'+currentChannel).on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:'channel=eq.'+currentChannel},function(payload){var container=document.getElementById('chat-messages');var emptyEl=container.querySelector('.empty');if(emptyEl)emptyEl.remove();container.insertAdjacentHTML('beforeend',chatBubble(payload.new));container.scrollTop=container.scrollHeight}).subscribe()}
async function sendMessage(){var input=document.getElementById('chat-input');var raw=input.value.trim();if(!raw)return;if(currentChannel.startsWith('dm_')&&!selectedDmUser)return alert('Select a user');input.value='';var isEnc=currentChannel.startsWith('dm_');var content=isEnc?e2eEncrypt(raw):raw;var res=await sb.from('messages').insert({user_id:currentUser.id,author_name:currentProfile?currentProfile.full_name||currentUser.email:currentUser.email,content:content,channel:currentChannel,encrypted:isEnc});if(res.error)alert("Error: "+res.error.message)}
async function adminCreateUser(){if(!isAdmin())return;var name=document.getElementById('admin-new-name').value.trim();var email=document.getElementById('admin-new-email').value.trim();var pass=document.getElementById('admin-new-pass').value;var role=document.getElementById('admin-new-role').value;var chat=document.getElementById('admin-new-chat').checked;var statusEl=document.getElementById('admin-create-status');if(!name||!email||!pass)return alert("All fields required.");if(pass.length<6)return alert("Min 6 chars.");statusEl.innerText="Creating...";var res=await sb.auth.signUp({email:email,password:pass,options:{data:{full_name:name,role:role,chat_enabled:chat.toString()}}});if(res.error){statusEl.innerText="Error: "+res.error.message;statusEl.style.color="var(--danger)";return}statusEl.innerText='\u2713 "'+name+'" created';statusEl.style.color="var(--primary)";document.getElementById('admin-new-name').value='';document.getElementById('admin-new-email').value='';document.getElementById('admin-new-pass').value='';setTimeout(function(){window.location.reload()},1500)}
async function loadAdminAppRequests(){if(!isAdmin())return;var res=await sb.from('app_requests').select('*').order('created_at',{ascending:false});var data=res.data;var c=document.getElementById('admin-app-requests');if(!data||!data.length){c.innerHTML='<div class="empty"><div class="empty-icon">\uD83D\uDCF1</div>No requests</div>';return}c.innerHTML=data.map(function(r){return'<div class="card"><div class="card-header"><div><div class="card-title">'+esc(r.app_name)+'</div><div class="card-meta">'+esc(r.user_name||'?')+' \u2022 '+timeAgo(r.created_at)+'</div></div><span class="badge badge-'+r.status+'">'+r.status+'</span></div>'+(r.description?'<div class="card-body">'+esc(r.description)+'</div>':'')+'<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap"><input type="number" id="price-'+r.id+'" placeholder="$" value="'+(r.price||'')+'" style="width:80px;padding:8px;font-size:.75rem"><input type="text" id="note-'+r.id+'" placeholder="Note" value="'+esc(r.admin_note||'')+'" style="flex:1;min-width:120px;padding:8px;font-size:.75rem"><button onclick="updateAppRequest(\''+r.id+'\',\'quoted\')" class="btn btn-warn btn-sm">Price</button><button onclick="updateAppRequest(\''+r.id+'\',\'approved\')" class="btn btn-primary btn-sm">OK</button><button onclick="updateAppRequest(\''+r.id+'\',\'declined\')" class="btn btn-danger btn-sm">No</button></div></div>'}).join('')}
async function updateAppRequest(id,status){if(!isAdmin())return;var p=document.getElementById('price-'+id);var n=document.getElementById('note-'+id);var update={status:status,admin_note:n?n.value:''};if(p&&p.value&&!isNaN(p.value))update.price=parseFloat(p.value);await sb.from('app_requests').update(update).eq('id',id);loadAdminAppRequests()}
async function loadAdminTickets(){if(!isAdmin())return;var res=await sb.from('tickets').select('*').order('created_at',{ascending:false});var c=document.getElementById('admin-ticket-list');c.innerHTML=!res.data||!res.data.length?'<div class="empty">No tickets</div>':res.data.map(function(t){return ticketCard(t,true)}).join('')}
async function updateTicketStatus(id,s){await sb.from('tickets').update({status:s}).eq('id',id)}
async function loadAdminReports(){if(!isAdmin())return;var res=await sb.from('reports').select('*').order('created_at',{ascending:false});var c=document.getElementById('admin-reports-list');if(!res.data||!res.data.length){c.innerHTML='<div class="empty">\u2705 No reports</div>';return}c.innerHTML=res.data.map(function(r){return'<div class="card"><div class="card-header"><div><div class="card-title">'+(r.type==='block'?'\uD83D\uDEAB':'\u26A0\uFE0F')+' '+esc(r.reported_name)+'</div><div class="card-meta">by '+esc(r.reporter_name)+' \u2022 '+timeAgo(r.created_at)+'</div></div><span class="badge badge-'+(r.type==='block'?'urgent':'high')+'">'+r.type+'</span></div>'+(r.reason?'<div class="card-body">'+esc(r.reason)+'</div>':'')+'</div>'}).join('')}
bootstrap();
</script>
</body>
</html>

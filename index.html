<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velo Cloud | UmeÃ¥ Engineering</title>

    <script type="module">
        let loaded = false;
        try {
            const mod = await import('https://esm.sh/@supabase/supabase-js@2');
            window.supabaseCreateClient = mod.createClient;
            loaded = true;
        } catch(e) { console.warn("esm.sh blocked", e); }

        if (!loaded) {
            try {
                const mod = await import('https://unpkg.com/@supabase/supabase-js@2/dist/module/index.js');
                window.supabaseCreateClient = mod.createClient;
                loaded = true;
            } catch(e) { console.warn("unpkg blocked", e); }
        }

        if (!loaded) {
            try {
                const mod = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
                window.supabaseCreateClient = mod.createClient;
                loaded = true;
            } catch(e) { console.warn("skypack blocked", e); }
        }
        window.__supabaseReady = loaded;
    </script>

    <style>
        :root {
            --bg: #050505; --card: #121212; --card-hover: #1a1a1a;
            --primary: #3ddc84; --primary-dim: rgba(61,220,132,0.15);
            --danger: #ff4b4b; --danger-dim: rgba(255,75,75,0.15);
            --warn: #f59e0b; --warn-dim: rgba(245,158,11,0.15);
            --blue: #3b82f6; --blue-dim: rgba(59,130,246,0.15);
            --text: #ffffff; --text-dim: #94a3b8;
            --border: rgba(255,255,255,0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; }

        /* Status Bar */
        #status { font-size: 0.65rem; padding: 8px; color: var(--primary); text-align: center;
                  letter-spacing: 2px; text-transform: uppercase; background: rgba(61,220,132,0.05);
                  border-bottom: 1px solid var(--border); }

        /* Layout */
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
        .view { display: none; }
        .view.active { display: block; }

        /* Auth Card */
        .auth-card { background: var(--card); padding: 40px; border-radius: 24px;
                     border: 1px solid var(--border); max-width: 420px; margin: 0 auto; }
        .auth-card h2 { margin-bottom: 20px; }

        /* Inputs */
        input, textarea, select {
            width: 100%; padding: 14px 16px; margin: 6px 0; background: #000;
            border: 1px solid var(--border); color: #fff; border-radius: 12px;
            font-size: 0.9rem; outline: none; transition: border 0.2s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); }
        textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        select { cursor: pointer; }
        select option { background: #111; }

        /* Buttons */
        .btn { padding: 14px 28px; border-radius: 12px; border: none; font-weight: 700;
               cursor: pointer; font-size: 0.9rem; width: 100%; margin-top: 8px;
               transition: opacity 0.2s, transform 0.1s; }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-dark { background: #1a1a1a; color: #fff; border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-sm { padding: 8px 16px; font-size: 0.75rem; width: auto; margin: 0; }

        /* Top Bar */
        .topbar { display: flex; justify-content: space-between; align-items: center;
                  padding: 16px 0; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
        .topbar-left h1 { font-size: 1.4rem; }
        .topbar-left h1 span { color: var(--primary); }
        .topbar-right { display: flex; align-items: center; gap: 12px; }
        .role-badge { font-size: 0.65rem; padding: 4px 10px; border-radius: 20px;
                      font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
        .role-admin { background: var(--warn-dim); color: var(--warn); }
        .role-client { background: var(--blue-dim); color: var(--blue); }

        /* Tab Navigation */
        .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: var(--card);
                padding: 4px; border-radius: 14px; border: 1px solid var(--border); }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 10px; cursor: pointer;
               font-size: 0.8rem; font-weight: 600; color: var(--text-dim); transition: all 0.2s; }
        .tab:hover { color: var(--text); }
        .tab.active { background: var(--primary); color: #000; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Cards */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px;
                padding: 20px; margin-bottom: 12px; transition: background 0.2s; }
        .card:hover { background: var(--card-hover); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start;
                       margin-bottom: 10px; }
        .card-title { font-weight: 700; font-size: 0.95rem; }
        .card-meta { font-size: 0.7rem; color: var(--text-dim); }
        .card-body { color: var(--text-dim); font-size: 0.85rem; line-height: 1.5; }

        /* Badges */
        .badge { font-size: 0.6rem; padding: 3px 8px; border-radius: 8px;
                 font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase; display: inline-block; }
        .badge-open { background: var(--primary-dim); color: var(--primary); }
        .badge-in_progress { background: var(--warn-dim); color: var(--warn); }
        .badge-closed { background: rgba(255,255,255,0.08); color: var(--text-dim); }
        .badge-low { background: rgba(255,255,255,0.05); color: var(--text-dim); }
        .badge-normal { background: var(--blue-dim); color: var(--blue); }
        .badge-high { background: var(--warn-dim); color: var(--warn); }
        .badge-urgent { background: var(--danger-dim); color: var(--danger); }

        /* User Table (Admin) */
        .user-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .user-table th { text-align: left; padding: 12px; color: var(--text-dim);
                         border-bottom: 1px solid var(--border); font-size: 0.7rem;
                         letter-spacing: 1px; text-transform: uppercase; }
        .user-table td { padding: 12px; border-bottom: 1px solid var(--border); }
        .user-table tr:hover td { background: var(--card-hover); }

        /* Empty State */
        .empty { text-align: center; padding: 40px; color: var(--text-dim); }
        .empty-icon { font-size: 2rem; margin-bottom: 10px; }

        /* Form Section */
        .form-section { background: var(--card); border: 1px solid var(--border);
                        border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .form-section h3 { margin-bottom: 16px; font-size: 0.95rem; }
        .form-row { display: flex; gap: 10px; }
        .form-row > * { flex: 1; }

        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
            .topbar { flex-direction: column; gap: 10px; text-align: center; }
            .topbar-right { justify-content: center; }
        }
    </style>
</head>
<body>

<div id="status">INITIALIZING SYSTEM...</div>

<div class="container">

    <!-- ==================== LANDING ==================== -->
    <div id="view-landing" class="view active">
        <div style="padding: 80px 0; text-align: center;">
            <h1 style="font-size: 3rem; margin-bottom: 8px;">VELO<span style="color:var(--primary)">.CLOUD</span></h1>
            <p style="color:var(--text-dim); margin-bottom: 32px;">Native Android & Web Engineering Node</p>
            <button onclick="router('login')" class="btn btn-primary" style="max-width:300px; margin:0 auto;">Client Portal</button>
        </div>
    </div>

    <!-- ==================== LOGIN ==================== -->
    <div id="view-login" class="view">
        <div class="auth-card">
            <h2>Portal Login</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="Password">
            <button onclick="handleLogin()" class="btn btn-primary">Enter Cloud</button>
            <p onclick="router('landing')" style="margin-top:20px; cursor:pointer; font-size:0.8rem; color:var(--text-dim); text-align:center;">â† Back</p>
        </div>
    </div>

    <!-- ==================== DASHBOARD ==================== -->
    <div id="view-dashboard" class="view">

        <!-- Top Bar -->
        <div class="topbar">
            <div class="topbar-left">
                <h1>VELO<span>.CLOUD</span></h1>
            </div>
            <div class="topbar-right">
                <span id="dash-email" style="font-size:0.8rem; color:var(--text-dim);"></span>
                <span id="dash-role-badge" class="role-badge"></span>
                <button onclick="handleLogout()" class="btn btn-dark btn-sm">Sign Out</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs" id="tab-bar">
            <div class="tab active" onclick="switchTab('overview')">Overview</div>
            <div class="tab" onclick="switchTab('tickets')">Tickets</div>
            <div class="tab" onclick="switchTab('community')">Community</div>
            <div class="tab" id="tab-admin" onclick="switchTab('admin')" style="display:none;">Admin</div>
        </div>

        <!-- ====== TAB: OVERVIEW ====== -->
        <div id="panel-overview" class="tab-content active">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:24px;">
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem; font-weight:800;" id="stat-tickets">0</div>
                    <div style="color:var(--text-dim); font-size:0.75rem; margin-top:4px;">YOUR TICKETS</div>
                </div>
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem; font-weight:800;" id="stat-open">0</div>
                    <div style="color:var(--text-dim); font-size:0.75rem; margin-top:4px;">OPEN</div>
                </div>
                <div class="card" style="text-align:center;">
                    <div style="font-size:2rem; font-weight:800;" id="stat-posts">0</div>
                    <div style="color:var(--text-dim); font-size:0.75rem; margin-top:4px;">COMMUNITY POSTS</div>
                </div>
            </div>
            <h3 style="margin-bottom:12px; font-size:0.9rem; color:var(--text-dim);">RECENT TICKETS</h3>
            <div id="overview-tickets"></div>
        </div>

        <!-- ====== TAB: TICKETS ====== -->
        <div id="panel-tickets" class="tab-content">
            <!-- New Ticket Form -->
            <div class="form-section">
                <h3>ğŸ“ New Support Ticket</h3>
                <input type="text" id="ticket-subject" placeholder="Subject">
                <textarea id="ticket-desc" placeholder="Describe your issue..."></textarea>
                <div class="form-row">
                    <select id="ticket-priority">
                        <option value="low">Low Priority</option>
                        <option value="normal" selected>Normal Priority</option>
                        <option value="high">High Priority</option>
                        <option value="urgent">Urgent</option>
                    </select>
                    <button onclick="createTicket()" class="btn btn-primary">Submit Ticket</button>
                </div>
            </div>
            <h3 style="margin-bottom:12px; font-size:0.9rem; color:var(--text-dim);">YOUR TICKETS</h3>
            <div id="ticket-list"></div>
        </div>

        <!-- ====== TAB: COMMUNITY ====== -->
        <div id="panel-community" class="tab-content">
            <div class="form-section">
                <h3>ğŸ’¬ New Post</h3>
                <textarea id="post-content" placeholder="Share something with the community..."></textarea>
                <button onclick="createPost()" class="btn btn-primary">Post</button>
            </div>
            <div id="post-list"></div>
        </div>

        <!-- ====== TAB: ADMIN (hidden for clients) ====== -->
        <div id="panel-admin" class="tab-content">
            <h3 style="margin-bottom:16px;">ğŸ” Admin Panel â€” User Management</h3>
            <div style="overflow-x:auto;">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Joined</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="admin-user-list"></tbody>
                </table>
            </div>

            <h3 style="margin: 32px 0 16px;">ğŸ“‹ All Tickets</h3>
            <div id="admin-ticket-list"></div>
        </div>

    </div><!-- /view-dashboard -->
</div>

<script>
    const SB_URL = 'https://lqkpxervwakucksrnoss.supabase.co';
    const SB_KEY = 'sb_publishable_Sdi0YJz0IPwK9yV-0tLvCw_9IDZQhD8';

    let sb = null;
    let currentUser = null;
    let currentProfile = null;

    // â”€â”€â”€ Router â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function router(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('view-' + id)?.classList.add('active');
    }

    // â”€â”€â”€ Tab Switcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function switchTab(name) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-' + name)?.classList.add('active');
        // highlight tab
        [...document.querySelectorAll('.tab')].find(t =>
            t.textContent.trim().toLowerCase() === name
        )?.classList.add('active');

        // refresh data on tab switch
        if (name === 'tickets')   loadTickets();
        if (name === 'community') loadPosts();
        if (name === 'admin')     { loadAdminUsers(); loadAdminTickets(); }
        if (name === 'overview')  loadOverview();
    }

    // â”€â”€â”€ Bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function bootstrap() {
        const status = document.getElementById('status');

        let attempts = 0;
        while (!window.__supabaseReady && attempts < 40) {
            await new Promise(r => setTimeout(r, 100));
            attempts++;
        }

        if (!window.supabaseCreateClient) {
            status.innerText = "CRITICAL: ALL CDNs BLOCKED â€” DISABLE AD-BLOCKER & REFRESH.";
            status.style.color = "#ff4b4b";
            return;
        }

        try {
            sb = window.supabaseCreateClient(SB_URL, SB_KEY);
            status.innerText = "SYSTEM ONLINE";

            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadProfile();
                setupDashboard();
                router('dashboard');
                loadOverview();
            }
        } catch (e) {
            status.innerText = "INIT ERROR: " + e.message;
            status.style.color = "#ff4b4b";
        }
    }

    // â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleLogin() {
        const email = document.getElementById('email').value.trim();
        const pass  = document.getElementById('pass').value;
        if (!sb) return alert("System not ready.");
        if (!email || !pass) return alert("Enter email and password.");

        const { error } = await sb.auth.signInWithPassword({ email, password: pass });
        if (error) alert("Login Failed: " + error.message);
        else window.location.reload();
    }

    async function handleLogout() {
        if (sb) await sb.auth.signOut();
        window.location.reload();
    }

    // â”€â”€â”€ Load Profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadProfile() {
        const { data, error } = await sb.from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        if (data) currentProfile = data;
    }

    function isAdmin() {
        return currentProfile?.role === 'admin';
    }

    // â”€â”€â”€ Setup Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setupDashboard() {
        document.getElementById('dash-email').innerText = currentUser.email;
        const badge = document.getElementById('dash-role-badge');
        badge.innerText = currentProfile?.role || 'client';
        badge.className = 'role-badge ' + (isAdmin() ? 'role-admin' : 'role-client');

        // Show admin tab if admin
        if (isAdmin()) {
            document.getElementById('tab-admin').style.display = '';
        }
    }

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function timeAgo(dateStr) {
        const diff = Date.now() - new Date(dateStr).getTime();
        const mins = Math.floor(diff / 60000);
        if (mins < 1) return 'just now';
        if (mins < 60) return mins + 'm ago';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ago';
        const days = Math.floor(hrs / 24);
        return days + 'd ago';
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str || '';
        return div.innerHTML;
    }

    // â”€â”€â”€ Overview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadOverview() {
        const { data: tickets } = await sb.from('tickets').select('*')
            .order('created_at', { ascending: false }).limit(5);

        const { count: postCount } = await sb.from('posts')
            .select('*', { count: 'exact', head: true });

        const allTickets = tickets || [];
        const openCount = allTickets.filter(t => t.status === 'open').length;

        document.getElementById('stat-tickets').innerText = allTickets.length;
        document.getElementById('stat-open').innerText = openCount;
        document.getElementById('stat-posts').innerText = postCount || 0;

        const container = document.getElementById('overview-tickets');
        if (!allTickets.length) {
            container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“­</div>No tickets yet</div>`;
            return;
        }
        container.innerHTML = allTickets.slice(0, 3).map(t => ticketCard(t)).join('');
    }

    // â”€â”€â”€ Tickets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function ticketCard(t, showAdmin = false) {
        return `
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">${escapeHtml(t.subject)}</div>
                    <div class="card-meta">${timeAgo(t.created_at)}</div>
                </div>
                <div style="display:flex; gap:6px; align-items:center;">
                    <span class="badge badge-${t.priority}">${t.priority}</span>
                    <span class="badge badge-${t.status}">${t.status.replace('_', ' ')}</span>
                </div>
            </div>
            ${t.description ? `<div class="card-body">${escapeHtml(t.description)}</div>` : ''}
            ${showAdmin ? `
            <div style="margin-top:12px; display:flex; gap:6px;">
                <select onchange="updateTicketStatus('${t.id}', this.value)" style="width:auto; padding:6px 10px; font-size:0.75rem;">
                    <option value="open" ${t.status==='open'?'selected':''}>Open</option>
                    <option value="in_progress" ${t.status==='in_progress'?'selected':''}>In Progress</option>
                    <option value="closed" ${t.status==='closed'?'selected':''}>Closed</option>
                </select>
            </div>` : ''}
        </div>`;
    }

    async function loadTickets() {
        const { data } = await sb.from('tickets').select('*')
            .order('created_at', { ascending: false });

        const container = document.getElementById('ticket-list');
        if (!data?.length) {
            container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“­</div>No tickets yet. Create one above!</div>`;
            return;
        }
        container.innerHTML = data.map(t => ticketCard(t)).join('');
    }

    async function createTicket() {
        const subject = document.getElementById('ticket-subject').value.trim();
        const description = document.getElementById('ticket-desc').value.trim();
        const priority = document.getElementById('ticket-priority').value;

        if (!subject) return alert("Subject is required.");

        const { error } = await sb.from('tickets').insert({
            user_id: currentUser.id,
            subject,
            description,
            priority
        });

        if (error) return alert("Error: " + error.message);

        document.getElementById('ticket-subject').value = '';
        document.getElementById('ticket-desc').value = '';
        document.getElementById('ticket-priority').value = 'normal';
        loadTickets();
    }

    // â”€â”€â”€ Community Posts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadPosts() {
        const { data } = await sb.from('posts').select('*')
            .order('created_at', { ascending: false });

        const container = document.getElementById('post-list');
        if (!data?.length) {
            container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ’¬</div>No posts yet. Start the conversation!</div>`;
            return;
        }
        container.innerHTML = data.map(p => `
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">${escapeHtml(p.author_name || 'Anonymous')}</div>
                        <div class="card-meta">${timeAgo(p.created_at)}</div>
                    </div>
                    ${(p.user_id === currentUser.id || isAdmin()) ? `
                        <button onclick="deletePost('${p.id}')" class="btn btn-danger btn-sm">âœ•</button>
                    ` : ''}
                </div>
                <div class="card-body">${escapeHtml(p.content)}</div>
            </div>
        `).join('');
    }

    async function createPost() {
        const content = document.getElementById('post-content').value.trim();
        if (!content) return alert("Write something first!");

        const { error } = await sb.from('posts').insert({
            user_id: currentUser.id,
            author_name: currentProfile?.full_name || currentUser.email,
            content
        });

        if (error) return alert("Error: " + error.message);
        document.getElementById('post-content').value = '';
        loadPosts();
    }

    async function deletePost(id) {
        if (!confirm("Delete this post?")) return;
        await sb.from('posts').delete().eq('id', id);
        loadPosts();
    }

    // â”€â”€â”€ Admin: Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAdminUsers() {
        if (!isAdmin()) return;

        const { data } = await sb.from('profiles').select('*')
            .order('created_at', { ascending: true });

        const tbody = document.getElementById('admin-user-list');
        if (!data?.length) { tbody.innerHTML = '<tr><td colspan="4">No users</td></tr>'; return; }

        tbody.innerHTML = data.map(u => `
            <tr>
                <td>
                    <div style="font-weight:600;">${escapeHtml(u.full_name || 'â€”')}</div>
                    <div style="font-size:0.7rem; color:var(--text-dim);">${u.id.slice(0,8)}...</div>
                </td>
                <td>
                    <select onchange="changeRole('${u.id}', this.value)"
                            style="width:auto; padding:6px 10px; font-size:0.75rem; background:#000;">
                        <option value="client" ${u.role==='client'?'selected':''}>Client</option>
                        <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                    </select>
                </td>
                <td style="font-size:0.75rem; color:var(--text-dim);">${new Date(u.created_at).toLocaleDateString()}</td>
                <td>
                    <span class="badge ${u.role==='admin'?'badge-high':'badge-normal'}">${u.role}</span>
                </td>
            </tr>
        `).join('');
    }

    async function changeRole(userId, newRole) {
        if (!isAdmin()) return;
        if (!confirm(`Change this user to "${newRole}"?`)) return;

        const { error } = await sb.from('profiles')
            .update({ role: newRole })
            .eq('id', userId);

        if (error) alert("Error: " + error.message);
        else loadAdminUsers();
    }

    // â”€â”€â”€ Admin: All Tickets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadAdminTickets() {
        if (!isAdmin()) return;

        const { data } = await sb.from('tickets').select('*')
            .order('created_at', { ascending: false });

        const container = document.getElementById('admin-ticket-list');
        if (!data?.length) {
            container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div>No tickets in system</div>`;
            return;
        }
        container.innerHTML = data.map(t => ticketCard(t, true)).join('');
    }

    async function updateTicketStatus(ticketId, newStatus) {
        const { error } = await sb.from('tickets')
            .update({ status: newStatus })
            .eq('id', ticketId);

        if (error) alert("Error: " + error.message);
    }

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    bootstrap();
</script>
</body>
</html>

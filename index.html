<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Velo Cloud | UmeÃ¥ Engineering</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script type="module">
let loaded = false;
try { const mod = await import('https://esm.sh/@supabase/supabase-js@2'); window.supabaseCreateClient = mod.createClient; loaded = true; } catch(e) { console.warn("esm.sh blocked", e); }
if (!loaded) { try { const mod = await import('https://unpkg.com/@supabase/supabase-js@2/dist/module/index.js'); window.supabaseCreateClient = mod.createClient; loaded = true; } catch(e) { console.warn("unpkg blocked", e); } }
if (!loaded) { try { const mod = await import('https://cdn.skypack.dev/@supabase/supabase-js@2'); window.supabaseCreateClient = mod.createClient; loaded = true; } catch(e) { console.warn("skypack blocked", e); } }
window.__supabaseReady = loaded;
</script>
<style>
:root{--bg:#030305;--card:#0d0d12;--card-hover:#14141c;--primary:#3ddc84;--primary-glow:rgba(61,220,132,0.25);--primary-dim:rgba(61,220,132,0.12);--danger:#ff4b4b;--danger-dim:rgba(255,75,75,0.15);--warn:#f59e0b;--warn-dim:rgba(245,158,11,0.15);--blue:#3b82f6;--blue-dim:rgba(59,130,246,0.15);--purple:#a855f7;--purple-dim:rgba(168,85,247,0.15);--text:#f0f0f5;--text-dim:#6b7280;--border:rgba(255,255,255,0.06);--glass:rgba(13,13,18,0.7)}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;overflow-x:hidden}
#status{font-size:.6rem;padding:6px;color:var(--primary);text-align:center;letter-spacing:3px;text-transform:uppercase;background:rgba(61,220,132,0.03);border-bottom:1px solid var(--border)}
.container{max-width:960px;margin:0 auto;padding:30px 20px}
.view{display:none}
.view.active{display:block}
.landing-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(61,220,132,0.08) 0%,transparent 60%),radial-gradient(ellipse 40% 50% at 80% 50%,rgba(59,130,246,0.05) 0%,transparent 50%),radial-gradient(ellipse 40% 40% at 20% 80%,rgba(168,85,247,0.04) 0%,transparent 50%)}
.grid-overlay{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(255,255,255,0.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.015) 1px,transparent 1px);background-size:60px 60px}
.landing-nav{position:relative;z-index:2;display:flex;justify-content:space-between;align-items:center;padding:24px 40px;max-width:1200px;margin:0 auto}
.landing-nav .logo{font-size:1.3rem;font-weight:900;letter-spacing:-0.5px}
.landing-nav .logo span{color:var(--primary)}
.landing-nav .nav-links{display:flex;gap:8px}
.landing-hero{position:relative;z-index:2;text-align:center;padding:120px 20px 60px;max-width:800px;margin:0 auto}
.landing-hero .pill{display:inline-block;padding:6px 16px;border-radius:50px;background:var(--primary-dim);color:var(--primary);font-size:.7rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:24px;border:1px solid rgba(61,220,132,0.2)}
.landing-hero h1{font-size:clamp(2.5rem,6vw,4.5rem);font-weight:900;line-height:1.05;letter-spacing:-2px;margin-bottom:20px}
.landing-hero h1 .gradient-text{background:linear-gradient(135deg,var(--primary),#22d3ee,var(--primary));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.landing-hero p{color:var(--text-dim);font-size:1.1rem;line-height:1.7;max-width:550px;margin:0 auto 40px}
.hero-buttons{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.landing-features{position:relative;z-index:2;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;max-width:900px;margin:60px auto 0;padding:0 20px}
.feature-card{background:var(--glass);border:1px solid var(--border);border-radius:20px;padding:28px;backdrop-filter:blur(10px);transition:border-color 0.3s,transform 0.2s}
.feature-card:hover{border-color:rgba(61,220,132,0.2);transform:translateY(-2px)}
.feature-icon{font-size:1.8rem;margin-bottom:14px}
.feature-card h3{font-size:.95rem;margin-bottom:8px;font-weight:700}
.feature-card p{font-size:.8rem;color:var(--text-dim);line-height:1.6}
.landing-footer{position:relative;z-index:2;text-align:center;padding:80px 20px 40px;color:var(--text-dim);font-size:.7rem}
.auth-card{background:var(--card);padding:40px;border-radius:24px;border:1px solid var(--border);max-width:420px;margin:60px auto;position:relative;z-index:2}
.auth-card h2{margin-bottom:4px;font-size:1.4rem}
.auth-card .subtitle{color:var(--text-dim);font-size:.8rem;margin-bottom:24px}
.auth-toggle{margin-top:20px;text-align:center;font-size:.8rem;color:var(--text-dim)}
.auth-toggle a{color:var(--primary);cursor:pointer;font-weight:600}
input,textarea,select{width:100%;padding:14px 16px;margin:6px 0;background:rgba(0,0,0,0.5);border:1px solid var(--border);color:#fff;border-radius:12px;font-size:.9rem;font-family:inherit;outline:none;transition:border 0.2s}
input:focus,textarea:focus,select:focus{border-color:var(--primary)}
textarea{resize:vertical;min-height:80px}
select{cursor:pointer}
select option{background:#111}
.input-label{font-size:.7rem;color:var(--text-dim);margin:10px 0 2px;text-transform:uppercase;letter-spacing:1px;display:block}
.btn{padding:14px 28px;border-radius:12px;border:none;font-weight:700;cursor:pointer;font-size:.9rem;width:100%;margin-top:8px;transition:all 0.2s;font-family:inherit;display:inline-flex;align-items:center;justify-content:center;gap:8px}
.btn:hover{opacity:0.9;transform:translateY(-1px)}
.btn:active{transform:scale(0.98)}
.btn-primary{background:var(--primary);color:#000}
.btn-primary-glow{background:var(--primary);color:#000;box-shadow:0 0 30px var(--primary-glow)}
.btn-dark{background:rgba(255,255,255,0.06);color:#fff;border:1px solid var(--border)}
.btn-danger{background:var(--danger);color:#fff}
.btn-warn{background:var(--warn);color:#000}
.btn-blue{background:var(--blue);color:#fff}
.btn-sm{padding:8px 16px;font-size:.75rem;width:auto;margin:0;border-radius:8px}
.btn-inline{width:auto}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 0;margin-bottom:24px;border-bottom:1px solid var(--border)}
.topbar-left h1{font-size:1.3rem;font-weight:900}
.topbar-left h1 span{color:var(--primary)}
.topbar-right{display:flex;align-items:center;gap:12px}
.role-badge{font-size:.6rem;padding:4px 10px;border-radius:20px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.role-admin{background:var(--warn-dim);color:var(--warn)}
.role-client{background:var(--blue-dim);color:var(--blue)}
.tabs{display:flex;gap:4px;margin-bottom:24px;background:var(--card);padding:4px;border-radius:14px;border:1px solid var(--border);overflow-x:auto}
.tab{flex:1;padding:12px;text-align:center;border-radius:10px;cursor:pointer;font-size:.78rem;font-weight:600;color:var(--text-dim);transition:all 0.2s;white-space:nowrap}
.tab:hover{color:var(--text)}
.tab.active{background:var(--primary);color:#000}
.tab-content{display:none}
.tab-content.active{display:block}
.sub-tabs{display:flex;gap:8px;margin-bottom:20px}
.sub-tab{padding:8px 16px;border-radius:8px;cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text-dim);background:rgba(255,255,255,0.03);border:1px solid var(--border);transition:all 0.2s}
.sub-tab:hover{color:var(--text)}
.sub-tab.active{background:var(--primary-dim);color:var(--primary);border-color:rgba(61,220,132,0.3)}
.sub-content{display:none}
.sub-content.active{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:12px;transition:all 0.2s}
.card:hover{background:var(--card-hover);border-color:rgba(255,255,255,0.1)}
.card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:12px}
.card-title{font-weight:700;font-size:.95rem}
.card-meta{font-size:.7rem;color:var(--text-dim)}
.card-body{color:var(--text-dim);font-size:.85rem;line-height:1.6}
.app-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
.app-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;text-align:center;transition:all 0.3s;position:relative;overflow:hidden}
.app-card:hover{border-color:rgba(61,220,132,0.2);transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.app-icon{font-size:2.5rem;margin-bottom:12px}
.app-card h4{font-size:.9rem;margin-bottom:6px}
.app-card p{font-size:.72rem;color:var(--text-dim);line-height:1.5;margin-bottom:12px}
.app-status-pill{display:inline-block;padding:3px 10px;border-radius:20px;font-size:.6rem;font-weight:700;letter-spacing:0.5px;text-transform:uppercase}
.app-status-in_progress{background:var(--warn-dim);color:var(--warn)}
.app-status-released{background:var(--primary-dim);color:var(--primary)}
.app-status-beta{background:var(--purple-dim);color:var(--purple)}
.badge{font-size:.6rem;padding:3px 8px;border-radius:8px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;display:inline-block}
.badge-open,.badge-pending{background:var(--primary-dim);color:var(--primary)}
.badge-in_progress,.badge-quoted{background:var(--warn-dim);color:var(--warn)}
.badge-closed,.badge-declined{background:rgba(255,255,255,0.06);color:var(--text-dim)}
.badge-approved{background:var(--primary-dim);color:var(--primary)}
.badge-low{background:rgba(255,255,255,0.04);color:var(--text-dim)}
.badge-normal{background:var(--blue-dim);color:var(--blue)}
.badge-high{background:var(--warn-dim);color:var(--warn)}
.badge-urgent{background:var(--danger-dim);color:var(--danger)}
.profile-header{display:flex;align-items:center;gap:20px;margin-bottom:30px}
.profile-avatar{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,var(--primary),#22d3ee);color:#000;flex-shrink:0;background-size:cover;background-position:center}
.profile-info h2{font-size:1.2rem}
.profile-info p{color:var(--text-dim);font-size:.8rem}
.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.chat-container{display:flex;flex-direction:column;height:60vh;background:var(--card);border:1px solid var(--border);border-radius:20px;overflow:hidden}
.chat-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.chat-header h3{font-size:.9rem}
.chat-online{font-size:.65rem;color:var(--primary);display:flex;align-items:center;gap:6px}
.chat-online::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--primary);display:inline-block}
.chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:8px}
.chat-messages::-webkit-scrollbar{width:4px}
.chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.chat-msg{max-width:75%;padding:12px 16px;border-radius:16px;font-size:.85rem;line-height:1.5;position:relative;word-wrap:break-word}
.chat-msg.mine{align-self:flex-end;background:var(--primary);color:#000;border-bottom-right-radius:4px}
.chat-msg.theirs{align-self:flex-start;background:rgba(255,255,255,0.06);border-bottom-left-radius:4px}
.chat-msg.encrypted{border:1px solid rgba(168,85,247,0.3)}
.chat-msg.mine.encrypted{background:linear-gradient(135deg,var(--primary),#22d3ee)}
.chat-msg .msg-author{font-size:.65rem;font-weight:700;margin-bottom:4px;opacity:0.7}
.chat-msg.mine .msg-author{color:#000}
.chat-msg .msg-time{font-size:.55rem;opacity:0.5;margin-top:4px;text-align:right}
.chat-msg.mine .msg-time{color:#000}
.chat-msg .msg-lock{font-size:.55rem;opacity:0.5}
.chat-input-bar{padding:14px;border-top:1px solid var(--border);display:flex;gap:10px}
.chat-input-bar input{flex:1;margin:0;background:rgba(0,0,0,0.4);border-radius:14px}
.chat-input-bar button{width:auto;margin:0;padding:12px 24px;border-radius:14px}
.chat-locked{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh;color:var(--text-dim);text-align:center;gap:12px}
.chat-locked-icon{font-size:3rem}
.e2e-badge{display:inline-flex;align-items:center;gap:4px;font-size:.6rem;color:var(--purple);background:var(--purple-dim);padding:3px 8px;border-radius:6px;font-weight:600}
.user-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;margin-bottom:16px}
.user-item{display:flex;align-items:center;gap:12px;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:10px;cursor:pointer;transition:all 0.2s}
.user-item:hover{background:rgba(255,255,255,0.06);border-color:rgba(61,220,132,0.2)}
.user-item.active{background:var(--primary-dim);border-color:var(--primary)}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#22d3ee);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:800;color:#000}
.user-name{flex:1;font-size:.85rem;font-weight:600}
.toggle{position:relative;display:inline-block;width:38px;height:22px}
.toggle input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#333;transition:0.3s;border-radius:22px}
.toggle-slider:before{content:"";position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;transition:0.3s;border-radius:50%}
.toggle input:checked+.toggle-slider{background:var(--primary)}
.toggle input:checked+.toggle-slider:before{transform:translateX(16px)}
.empty{text-align:center;padding:40px;color:var(--text-dim)}
.empty-icon{font-size:2rem;margin-bottom:10px}
.form-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}
.form-section h3{margin-bottom:16px;font-size:.95rem}
.form-row{display:flex;gap:10px}
.form-row>*{flex:1}
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;text-align:center}
.stat-value{font-size:2rem;font-weight:800}
.stat-label{color:var(--text-dim);font-size:.65rem;margin-top:4px;letter-spacing:1px;text-transform:uppercase}
.section-title{margin-bottom:12px;font-size:.75rem;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase}
.divider{height:1px;background:var(--border);margin:24px 0}
.price-tag{font-size:1.1rem;font-weight:800;color:var(--primary)}
@media (max-width:600px){.form-row{flex-direction:column}.topbar{flex-direction:column;gap:10px;text-align:center}.topbar-right{justify-content:center;flex-wrap:wrap}.landing-hero h1{letter-spacing:-1px}.landing-nav{padding:16px 20px}.profile-header{flex-direction:column;text-align:center}.profile-grid{grid-template-columns:1fr}.chat-msg{max-width:88%}.app-grid{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div id="status">INITIALIZING SYSTEM...</div>
<div id="view-landing" class="view active"><div class="landing-bg"></div><div class="grid-overlay"></div><nav class="landing-nav"><div class="logo">VELO<span>.CLOUD</span></div><div class="nav-links"><button onclick="router('login')" class="btn btn-dark btn-sm btn-inline">Sign In</button><button onclick="router('signup')" class="btn btn-primary btn-sm btn-inline">Get Started</button></div></nav><div class="landing-hero"><div class="pill">âš¡ UmeÃ¥ Engineering Node</div><h1>Build faster.<br><span class="gradient-text">Ship smarter.</span></h1><p>Native Android & Web engineering platform. Manage projects, track tickets, and collaborate â€” all from one secure cloud portal.</p><div class="hero-buttons"><button onclick="router('signup')" class="btn btn-primary-glow btn-inline" style="width:auto;padding:16px 40px">Start Free â†’</button><button onclick="router('login')" class="btn btn-dark btn-inline" style="width:auto;padding:16px 40px">Client Login</button></div></div><div class="landing-features"><div class="feature-card"><div class="feature-icon">ğŸ«</div><h3>Ticket System</h3><p>Submit and track support tickets with priority levels and real-time updates.</p></div><div class="feature-card"><div class="feature-icon">ğŸ“±</div><h3>App Marketplace</h3><p>Browse our catalog, request custom apps, and get quotes â€” all in one place.</p></div><div class="feature-card"><div class="feature-icon">ğŸ”</div><h3>Encrypted Chat</h3><p>End-to-end encrypted messaging channels with role-based access control.</p></div></div><div class="landing-footer"><p>VELO.CLOUD â€” UmeÃ¥, Sweden â€¢ Built with Supabase</p></div></div>
<div id="view-login" class="view"><div class="landing-bg"></div><div class="auth-card"><h2>Welcome back</h2><p class="subtitle">Sign in to your Velo Cloud portal</p><input type="email" id="login-email" placeholder="Email address"><input type="password" id="login-pass" placeholder="Password"><button onclick="handleLogin()" class="btn btn-primary" style="margin-top:16px">Sign In</button><div class="auth-toggle">Don't have an account? <a onclick="router('signup')">Create one</a></div><p onclick="router('landing')" style="margin-top:12px;cursor:pointer;font-size:.75rem;color:var(--text-dim);text-align:center">â† Back to home</p></div></div>
<div id="view-signup" class="view"><div class="landing-bg"></div><div class="auth-card"><h2>Create account</h2><p class="subtitle">Join Velo Cloud â€” it's free</p><input type="text" id="signup-name" placeholder="Full name"><input type="email" id="signup-email" placeholder="Email address"><input type="password" id="signup-pass" placeholder="Password (min 6 characters)"><button onclick="handleSignup()" class="btn btn-primary" style="margin-top:16px">Create Account</button><div class="auth-toggle">Already have an account? <a onclick="router('login')">Sign in</a></div><p onclick="router('landing')" style="margin-top:12px;cursor:pointer;font-size:.75rem;color:var(--text-dim);text-align:center">â† Back to home</p></div></div>
<div id="view-dashboard" class="view"><div class="container"><div class="topbar"><div class="topbar-left"><h1>VELO<span>.CLOUD</span></h1></div><div class="topbar-right"><span id="dash-email" style="font-size:.8rem;color:var(--text-dim)"></span><span id="dash-role-badge" class="role-badge"></span><button onclick="handleLogout()" class="btn btn-dark btn-sm">Sign Out</button></div></div><div class="tabs"><div class="tab active" data-tab="overview" onclick="switchTab('overview')">Overview</div><div class="tab" data-tab="apps" onclick="switchTab('apps')">Apps</div><div class="tab" data-tab="tickets" onclick="switchTab('tickets')">Tickets</div><div class="tab" data-tab="community" onclick="switchTab('community')">Community</div><div class="tab" data-tab="chat" id="tab-chat" onclick="switchTab('chat')" style="display:none">Chat</div><div class="tab" data-tab="profile" onclick="switchTab('profile')">Profile</div><div class="tab" data-tab="admin" id="tab-admin" onclick="switchTab('admin')" style="display:none">Admin</div></div><div id="panel-overview" class="tab-content active"><div class="stat-grid"><div class="stat-card"><div class="stat-value" id="stat-tickets">0</div><div class="stat-label">Tickets</div></div><div class="stat-card"><div class="stat-value" id="stat-open">0</div><div class="stat-label">Open</div></div><div class="stat-card"><div class="stat-value" id="stat-apps">0</div><div class="stat-label">Apps</div></div><div class="stat-card"><div class="stat-value" id="stat-posts">0</div><div class="stat-label">Posts</div></div></div><div class="section-title">Recent Tickets</div><div id="overview-tickets"></div></div><div id="panel-apps" class="tab-content"><div class="section-title">ğŸ“± App Catalog</div><div class="app-grid" id="app-catalog"></div><div class="divider"></div><div class="form-section"><h3>ğŸ›’ Request a Custom App</h3><input type="text" id="req-app-name" placeholder="App name (e.g. Fitness Tracker)"><textarea id="req-app-desc" placeholder="Describe what you want the app to do..."></textarea><button onclick="submitAppRequest()" class="btn btn-primary">Submit Request</button></div><div class="section-title">Your Requests</div><div id="my-app-requests"></div></div><div id="panel-tickets" class="tab-content"><div class="form-section"><h3>ğŸ“ New Support Ticket</h3><input type="text" id="ticket-subject" placeholder="Subject"><textarea id="ticket-desc" placeholder="Describe your issue..."></textarea><div class="form-row"><select id="ticket-priority"><option value="low">Low</option><option value="normal" selected>Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select><button onclick="createTicket()" class="btn btn-primary">Submit</button></div></div><div class="section-title">Your Tickets</div><div id="ticket-list"></div></div><div id="panel-community" class="tab-content"><div class="form-section"><h3>ğŸ’¬ New Post</h3><textarea id="post-content" placeholder="Share something..."></textarea><button onclick="createPost()" class="btn btn-primary">Post</button></div><div id="post-list"></div></div><div id="panel-chat" class="tab-content"><div id="chat-locked" class="chat-locked"><div class="chat-locked-icon">ğŸ”’</div><h3>Chat Access Required</h3><p style="color:var(--text-dim);font-size:.85rem;max-width:400px">Chat is invite-only. An admin must enable chat access for your account.</p></div><div id="chat-unlocked" style="display:none"><div class="sub-tabs"><div class="sub-tab active" onclick="switchChatChannel('team')">ğŸ’¬ Team Chat</div><div class="sub-tab" onclick="switchChatChannel('dm')">ğŸ” Private DM</div></div><div id="chat-dm-selector" style="display:none;margin-bottom:20px"><div class="section-title">Select User to Chat With</div><div class="user-list" id="dm-user-list"></div></div><div class="chat-container"><div class="chat-header"><h3 id="chat-channel-title">ğŸ’¬ Team Chat</h3><div style="display:flex;align-items:center;gap:10px"><span id="chat-e2e-badge" class="e2e-badge" style="display:none">ğŸ” E2E</span><div class="chat-online">Live</div></div></div><div class="chat-messages" id="chat-messages"></div><div class="chat-input-bar"><input type="text" id="chat-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendMessage()"><button onclick="sendMessage()" class="btn btn-primary">Send</button></div></div></div></div><div id="panel-profile" class="tab-content"><div class="profile-header"><div class="profile-avatar" id="profile-avatar">?</div><div class="profile-info"><h2 id="profile-display-name">â€”</h2><p id="profile-display-email">â€”</p><span id="profile-display-role" class="role-badge" style="margin-top:6px"></span></div></div><div class="form-section"><h3>âœï¸ Edit Profile</h3><label class="input-label">Full Name</label><input type="text" id="profile-name" placeholder="Your name"><label class="input-label">Avatar URL</label><input type="text" id="profile-avatar-url" placeholder="https://example.com/photo.jpg"><button onclick="saveProfile()" class="btn btn-primary" style="margin-top:12px">Save Changes</button></div><div class="form-section"><h3>ğŸ“Š Account Info</h3><div class="profile-grid"><div class="card" style="text-align:center"><div style="font-size:1.5rem;font-weight:800" id="profile-ticket-count">0</div><div style="color:var(--text-dim);font-size:.65rem;margin-top:4px">TICKETS</div></div><div class="card" style="text-align:center"><div style="font-size:1.5rem;font-weight:800" id="profile-post-count">0</div><div style="color:var(--text-dim);font-size:.65rem;margin-top:4px">POSTS</div></div></div></div></div><div id="panel-admin" class="tab-content"><div class="sub-tabs"><div class="sub-tab active" onclick="switchAdminPanel('users')">ğŸ‘¤ Add User</div><div class="sub-tab" onclick="switchAdminPanel('requests')">ğŸ“± App Requests</div><div class="sub-tab" onclick="switchAdminPanel('tickets')">ğŸ« Tickets</div></div><div id="admin-panel-users" class="sub-content active"><div class="form-section"><h3>â• Add New User</h3><div class="form-row"><div><label class="input-label">Full Name</label><input type="text" id="admin-new-name" placeholder="Full name"></div><div><label class="input-label">Email</label><input type="email" id="admin-new-email" placeholder="user@example.com"></div></div><div class="form-row"><div><label class="input-label">Password</label><input type="password" id="admin-new-pass" placeholder="Min 6 characters"></div><div><label class="input-label">Role</label><select id="admin-new-role"><option value="client">Client</option><option value="admin">Admin</option></select></div></div><div style="margin-top:12px;display:flex;align-items:center;gap:10px"><label class="toggle"><input type="checkbox" id="admin-new-chat"><span class="toggle-slider"></span></label><span style="font-size:.8rem;color:var(--text-dim)">Enable Chat Access</span></div><button onclick="adminCreateUser()" class="btn btn-primary" style="margin-top:12px">Create User</button><div id="admin-create-status" style="font-size:.75rem;margin-top:8px"></div></div></div><div id="admin-panel-requests" class="sub-content"><div class="section-title">Pending App Requests</div><div id="admin-app-requests"></div></div><div id="admin-panel-tickets" class="sub-content"><div class="section-title">All Tickets</div><div id="admin-ticket-list"></div></div></div></div></div>
<script>
const SB_URL='https://lqkpxervwakucksrnoss.supabase.co';
const SB_KEY='sb_publishable_Sdi0YJz0IPwK9yV-0tLvCw_9IDZQhD8';
let sb=null,currentUser=null,currentProfile=null,chatSubscription=null,currentChannel='team',selectedDmUser=null;
const E2E_KEY='velo-e2e-2026';
function e2eEncrypt(t){let r='';for(let i=0;i<t.length;i++)r+=String.fromCharCode(t.charCodeAt(i)^E2E_KEY.charCodeAt(i%E2E_KEY.length));return btoa(r)}
function e2eDecrypt(e){try{const d=atob(e);let r='';for(let i=0;i<d.length;i++)r+=String.fromCharCode(d.charCodeAt(i)^E2E_KEY.charCodeAt(i%E2E_KEY.length));return r}catch{return'[decryption failed]'}}
function getDmChannel(uid1,uid2){return[uid1,uid2].sort().join('_')}
function router(id){document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.getElementById('view-'+id)?.classList.add('active');if(id==='dashboard')window.scrollTo(0,0)}
function switchTab(n){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(p=>p.classList.remove('active'));document.getElementById('panel-'+n)?.classList.add('active');document.querySelector(`.tab[data-tab="${n}"]`)?.classList.add('active');if(n==='overview')loadOverview();if(n==='apps'){loadAppCatalog();loadMyAppRequests()}if(n==='tickets')loadTickets();if(n==='community')loadPosts();if(n==='chat')initChat();if(n==='profile')loadProfileTab();if(n==='admin'){loadAdminAppRequests();loadAdminTickets()}}
function switchAdminPanel(n){document.querySelectorAll('#panel-admin .sub-tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('#panel-admin .sub-content').forEach(p=>p.classList.remove('active'));document.getElementById('admin-panel-'+n)?.classList.add('active');const tabs=document.querySelectorAll('#panel-admin .sub-tab');const map={users:0,requests:1,tickets:2};if(tabs[map[n]])tabs[map[n]].classList.add('active');if(n==='requests')loadAdminAppRequests();if(n==='tickets')loadAdminTickets()}
async function switchChatChannel(ch){currentChannel=ch;document.querySelectorAll('#chat-unlocked .sub-tab').forEach(t=>t.classList.remove('active'));const tabs=document.querySelectorAll('#chat-unlocked .sub-tab');if(ch==='team')tabs[0]?.classList.add('active');else tabs[1]?.classList.add('active');if(ch==='dm'){document.getElementById('chat-dm-selector').style.display='block';await loadDmUserList();document.getElementById('chat-channel-title').innerText='ğŸ” Private DM';document.getElementById('chat-e2e-badge').style.display='';document.getElementById('chat-input').placeholder='Select a user to start chatting...';const container=document.getElementById('chat-messages');container.innerHTML=`<div class="empty" style="padding:60px 20px"><div class="empty-icon">ğŸ‘¥</div>Select a user from the list above to start an encrypted chat</div>`}else{document.getElementById('chat-dm-selector').style.display='none';selectedDmUser=null;document.getElementById('chat-channel-title').innerText='ğŸ’¬ Team Chat';document.getElementById('chat-e2e-badge').style.display='none';document.getElementById('chat-input').placeholder='Type a message...';await loadMessages();subscribeToChatRealtime()}}
async function loadDmUserList(){const{data}=await sb.from('profiles').select('id,full_name,avatar_url').or(`chat_enabled.eq.true,role.eq.admin`).neq('id',currentUser.id);const list=document.getElementById('dm-user-list');if(!data?.length){list.innerHTML=`<div class="empty" style="padding:20px;font-size:.8rem">No other chat users available</div>`;return}list.innerHTML=data.map(u=>{const initial=(u.full_name||'?')[0].toUpperCase();return`<div class="user-item" onclick="selectDmUser('${u.id}','${esc(u.full_name||'User')}')"><div class="user-avatar"${u.avatar_url?` style="background-image:url(${u.avatar_url});background-size:cover"`:''}>${u.avatar_url?'':initial}</div><div class="user-name">${esc(u.full_name||'Unknown')}</div></div>`}).join('')}
async function selectDmUser(uid,name){selectedDmUser=uid;currentChannel='dm_'+getDmChannel(currentUser.id,uid);document.querySelectorAll('.user-item').forEach(i=>i.classList.remove('active'));event.target.closest('.user-item').classList.add('active');document.getElementById('chat-channel-title').innerText=`ğŸ” DM: ${name}`;document.getElementById('chat-input').placeholder='Type an encrypted message...';await loadMessages();subscribeToChatRealtime()}
async function bootstrap(){const status=document.getElementById('status');let attempts=0;while(!window.__supabaseReady&&attempts<40){await new Promise(r=>setTimeout(r,100));attempts++}if(!window.supabaseCreateClient){status.innerText="CRITICAL: CDN BLOCKED";status.style.color="#ff4b4b";return}try{sb=window.supabaseCreateClient(SB_URL,SB_KEY);status.innerText="SYSTEM ONLINE";const{data:{session}}=await sb.auth.getSession();if(session){currentUser=session.user;await loadProfile();setupDashboard();router('dashboard');loadOverview()}}catch(e){status.innerText="ERROR: "+e.message;status.style.color="#ff4b4b"}}
async function handleLogin(){const email=document.getElementById('login-email').value.trim();const pass=document.getElementById('login-pass').value;if(!sb)return alert("System not ready.");if(!email||!pass)return alert("Enter email and password.");const{error}=await sb.auth.signInWithPassword({email,password:pass});if(error)alert("Login Failed: "+error.message);else window.location.reload()}
async function handleSignup(){const name=document.getElementById('signup-name').value.trim();const email=document.getElementById('signup-email').value.trim();const pass=document.getElementById('signup-pass').value;if(!sb)return alert("System not ready.");if(!name||!email||!pass)return alert("All fields are required.");if(pass.length<6)return alert("Password must be at least 6 characters.");const{error}=await sb.auth.signUp({email,password:pass,options:{data:{full_name:name}}});if(error)return alert("Signup Failed: "+error.message);alert("Account created! Check your email to confirm, then sign in.");router('login')}
async function handleLogout(){if(chatSubscription)sb.removeChannel(chatSubscription);if(sb)await sb.auth.signOut();window.location.reload()}
async function loadProfile(){const{data}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();if(data)currentProfile=data}
function isAdmin(){return currentProfile?.role==='admin'}
function hasChatAccess(){return isAdmin()||currentProfile?.chat_enabled===true}
function setupDashboard(){document.getElementById('dash-email').innerText=currentUser.email;const badge=document.getElementById('dash-role-badge');badge.innerText=currentProfile?.role||'client';badge.className='role-badge '+(isAdmin()?'role-admin':'role-client');if(isAdmin())document.getElementById('tab-admin').style.display='';if(hasChatAccess())document.getElementById('tab-chat').style.display=''}
async function loadProfileTab(){const avatar=document.getElementById('profile-avatar');const initial=(currentProfile?.full_name||currentUser.email||'?')[0].toUpperCase();if(currentProfile?.avatar_url){avatar.style.backgroundImage=`url(${currentProfile.avatar_url})`;avatar.innerText=''}else{avatar.style.backgroundImage='';avatar.innerText=initial}document.getElementById('profile-display-name').innerText=currentProfile?.full_name||'â€”';document.getElementById('profile-display-email').innerText=currentUser.email;const rb=document.getElementById('profile-display-role');rb.innerText=currentProfile?.role||'client';rb.className='role-badge '+(isAdmin()?'role-admin':'role-client');document.getElementById('profile-name').value=currentProfile?.full_name||'';document.getElementById('profile-avatar-url').value=currentProfile?.avatar_url||'';const{count:tc}=await sb.from('tickets').select('*',{count:'exact',head:true}).eq('user_id',currentUser.id);const{count:pc}=await sb.from('posts').select('*',{count:'exact',head:true}).eq('user_id',currentUser.id);document.getElementById('profile-ticket-count').innerText=tc||0;document.getElementById('profile-post-count').innerText=pc||0}
async function saveProfile(){const full_name=document.getElementById('profile-name').value.trim();const avatar_url=document.getElementById('profile-avatar-url').value.trim();if(!full_name)return alert("Name is required.");const{error}=await sb.from('profiles').update({full_name,avatar_url}).eq('id',currentUser.id);if(error)return alert("Error: "+error.message);await loadProfile();setupDashboard();loadProfileTab();alert("Profile updated!")}
function timeAgo(d){const diff=Date.now()-new Date(d).getTime();const m=Math.floor(diff/60000);if(m<1)return'just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';return Math.floor(h/24)+'d ago'}
function formatTime(d){return new Date(d).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}
async function loadOverview(){const{data:tickets}=await sb.from('tickets').select('*').order('created_at',{ascending:false}).limit(5);const{count:pc}=await sb.from('posts').select('*',{count:'exact',head:true});const{count:ac}=await sb.from('apps').select('*',{count:'exact',head:true});const all=tickets||[];document.getElementById('stat-tickets').innerText=all.length;document.getElementById('stat-open').innerText=all.filter(t=>t.status==='open').length;document.getElementById('stat-apps').innerText=ac||0;document.getElementById('stat-posts').innerText=pc||0;const c=document.getElementById('overview-tickets');c.innerHTML=!all.length?`<div class="empty"><div class="empty-icon">ğŸ“­</div>No tickets yet</div>`:all.slice(0,3).map(t=>ticketCard(t)).join('')}
async function loadAppCatalog(){const{data}=await sb.from('apps').select('*').eq('is_public',true).order('created_at');const c=document.getElementById('app-catalog');if(!data?.length){c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“±</div>No apps yet</div>`;return}c.innerHTML=data.map(a=>`<div class="app-card"><div class="app-icon">${a.icon}</div><h4>${esc(a.name)}</h4><p>${esc(a.description||'')}</p><span class="app-status-pill app-status-${a.status}">${a.status.replace('_',' ')}</span>${a.price>0?`<div class="price-tag" style="margin-top:8px">$${a.price}</div>`:''}</div>`).join('')}
async function submitAppRequest(){const app_name=document.getElementById('req-app-name').value.trim();const description=document.getElementById('req-app-desc').value.trim();if(!app_name)return alert("App name is required.");const{error}=await sb.from('app_requests').insert({user_id:currentUser.id,user_name:currentProfile?.full_name||currentUser.email,app_name,description});if(error)return alert("Error: "+error.message);document.getElementById('req-app-name').value='';document.getElementById('req-app-desc').value='';alert("Request submitted! We'll review it soon.");loadMyAppRequests()}
async function loadMyAppRequests(){const{data}=await sb.from('app_requests').select('*').eq('user_id',currentUser.id).order('created_at',{ascending:false});const c=document.getElementById('my-app-requests');if(!data?.length){c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“‹</div>No requests yet</div>`;return}c.innerHTML=data.map(r=>`<div class="card"><div class="card-header"><div><div class="card-title">${esc(r.app_name)}</div><div class="card-meta">${timeAgo(r.created_at)}</div></div><div style="display:flex;gap:6px;align-items:center"><span class="badge badge-${r.status}">${r.status}</span>${r.price!==null&&r.status==='quoted'?`<span class="price-tag">$${r.price}</span>`:''}</div></div>${r.description?`<div class="card-body">${esc(r.description)}</div>`:''}${r.admin_note?`<div style="margin-top:8px;padding:10px;background:var(--primary-dim);border-radius:10px;font-size:.8rem"><strong>Admin:</strong> ${esc(r.admin_note)}</div>`:''}</div>`).join('')}
function ticketCard(t,admin=false){return`<div class="card"><div class="card-header"><div><div class="card-title">${esc(t.subject)}</div><div class="card-meta">${timeAgo(t.created_at)}</div></div><div style="display:flex;gap:6px;align-items:center"><span class="badge badge-${t.priority}">${t.priority}</span><span class="badge badge-${t.status}">${t.status.replace('_',' ')}</span></div></div>${t.description?`<div class="card-body">${esc(t.description)}</div>`:''}${admin?`<div style="margin-top:12px"><select onchange="updateTicketStatus('${t.id}',this.value)" style="width:auto;padding:6px 10px;font-size:.75rem"><option value="open" ${t.status==='open'?'selected':''}>Open</option><option value="in_progress" ${t.status==='in_progress'?'selected':''}>In Progress</option><option value="closed" ${t.status==='closed'?'selected':''}>Closed</option></select></div>`:''}</div>`}
async function loadTickets(){const{data}=await sb.from('tickets').select('*').order('created_at',{ascending:false});const c=document.getElementById('ticket-list');c.innerHTML=!data?.length?`<div class="empty"><div class="empty-icon">ğŸ“­</div>No tickets yet</div>`:data.map(t=>ticketCard(t)).join('')}
async function createTicket(){const subject=document.getElementById('ticket-subject').value.trim();const description=document.getElementById('ticket-desc').value.trim();const priority=document.getElementById('ticket-priority').value;if(!subject)return alert("Subject is required.");const{error}=await sb.from('tickets').insert({user_id:currentUser.id,subject,description,priority});if(error)return alert("Error: "+error.message);document.getElementById('ticket-subject').value='';document.getElementById('ticket-desc').value='';document.getElementById('ticket-priority').value='normal';loadTickets()}
async function loadPosts(){const{data}=await sb.from('posts').select('*').order('created_at',{ascending:false});const c=document.getElementById('post-list');c.innerHTML=!data?.length?`<div class="empty"><div class="empty-icon">ğŸ’¬</div>No posts yet</div>`:data.map(p=>`<div class="card"><div class="card-header"><div><div class="card-title">${esc(p.author_name||'Anonymous')}</div><div class="card-meta">${timeAgo(p.created_at)}</div></div>${p.user_id===currentUser.id||isAdmin()?`<button onclick="deletePost('${p.id}')" class="btn btn-danger btn-sm">âœ•</button>`:''}</div><div class="card-body">${esc(p.content)}</div></div>`).join('')}
async function createPost(){const content=document.getElementById('post-content').value.trim();if(!content)return alert("Write something!");const{error}=await sb.from('posts').insert({user_id:currentUser.id,author_name:currentProfile?.full_name||currentUser.email,content});if(error)return alert("Error: "+error.message);document.getElementById('post-content').value='';loadPosts()}
async function deletePost(id){if(!confirm("Delete this post?"))return;await sb.from('posts').delete().eq('id',id);loadPosts()}
async function initChat(){if(hasChatAccess()){document.getElementById('chat-locked').style.display='none';document.getElementById('chat-unlocked').style.display='block';currentChannel='team';selectedDmUser=null;const tabs=document.querySelectorAll('#chat-unlocked .sub-tab');tabs.forEach(t=>t.classList.remove('active'));tabs[0]?.classList.add('active');document.getElementById('chat-dm-selector').style.display='none';document.getElementById('chat-channel-title').innerText='ğŸ’¬ Team Chat';document.getElementById('chat-e2e-badge').style.display='none';document.getElementById('chat-input').placeholder='Type a message...';await loadMessages();subscribeToChatRealtime()}else{document.getElementById('chat-locked').style.display='flex';document.getElementById('chat-unlocked').style.display='none'}}
async function loadMessages(){const{data}=await sb.from('messages').select('*').eq('channel',currentChannel).order('created_at',{ascending:true}).limit(200);const container=document.getElementById('chat-messages');if(!data?.length){const label=currentChannel.startsWith('dm_')?'No messages yet. Start the conversation!':'No messages yet. Say hello!';container.innerHTML=`<div class="empty" style="padding:60px 20px"><div class="empty-icon">${currentChannel.startsWith('dm_')?'ğŸ”':'ğŸ’¬'}</div>${label}</div>`;return}container.innerHTML=data.map(m=>chatBubble(m)).join('');container.scrollTop=container.scrollHeight}
function chatBubble(m){const mine=m.user_id===currentUser.id;const isEnc=m.encrypted||currentChannel.startsWith('dm_');const content=isEnc?e2eDecrypt(m.content):m.content;return`<div class="chat-msg ${mine?'mine':'theirs'} ${isEnc?'encrypted':''}">${!mine?`<div class="msg-author">${esc(m.author_name||'User')}</div>`:''}<div>${esc(content)}</div><div class="msg-time">${isEnc?'<span class="msg-lock">ğŸ”</span> ':''}${formatTime(m.created_at)}</div></div>`}
function subscribeToChatRealtime(){if(chatSubscription)sb.removeChannel(chatSubscription);chatSubscription=sb.channel('chat-'+currentChannel).on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:'channel=eq.'+currentChannel},(payload)=>{const container=document.getElementById('chat-messages');const emptyEl=container.querySelector('.empty');if(emptyEl)emptyEl.remove();container.insertAdjacentHTML('beforeend',chatBubble(payload.new));container.scrollTop=container.scrollHeight}).subscribe()}
async function sendMessage(){const input=document.getElementById('chat-input');const raw=input.value.trim();if(!raw)return;if(currentChannel.startsWith('dm_')&&!selectedDmUser)return alert('Select a user first');input.value='';const isEnc=currentChannel.startsWith('dm_');const content=isEnc?e2eEncrypt(raw):raw;const{error}=await sb.from('messages').insert({user_id:currentUser.id,author_name:currentProfile?.full_name||currentUser.email,content,channel:currentChannel,encrypted:isEnc});if(error)alert("Error: "+error.message)}
async function adminCreateUser(){if(!isAdmin())return;const name=document.getElementById('admin-new-name').value.trim();const email=document.getElementById('admin-new-email').value.trim();const pass=document.getElementById('admin-new-pass').value;const role=document.getElementById('admin-new-role').value;const chat=document.getElementById('admin-new-chat').checked;const statusEl=document.getElementById('admin-create-status');if(!name||!email||!pass)return alert("All fields are required.");if(pass.length<6)return alert("Password must be at least 6 characters.");statusEl.innerText="Creating user...";statusEl.style.color="var(--text-dim)";const{data,error}=await sb.auth.signUp({email,password:pass,options:{data:{full_name:name,role:role,chat_enabled:chat.toString()}}});if(error){statusEl.innerText="Error: "+error.message;statusEl.style.color="var(--danger)";return}const chatLabel=chat?' + chat enabled':'';statusEl.innerText=`âœ“ "${name}" created as ${role}${chatLabel}`;statusEl.style.color="var(--primary)";document.getElementById('admin-new-name').value='';document.getElementById('admin-new-email').value='';document.getElementById('admin-new-pass').value='';document.getElementById('admin-new-role').value='client';document.getElementById('admin-new-chat').checked=false;setTimeout(()=>{statusEl.innerText+=" â€” Restoring session...";window.location.reload()},1500)}
async function loadAdminAppRequests(){if(!isAdmin())return;const{data}=await sb.from('app_requests').select('*').order('created_at',{ascending:false});const c=document.getElementById('admin-app-requests');if(!data?.length){c.innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“±</div>No app requests</div>`;return}c.innerHTML=data.map(r=>`<div class="card"><div class="card-header"><div><div class="card-title">${esc(r.app_name)}</div><div class="card-meta">by ${esc(r.user_name||'Unknown')} â€¢ ${timeAgo(r.created_at)}</div></div><span class="badge badge-${r.status}">${r.status}</span></div>${r.description?`<div class="card-body">${esc(r.description)}</div>`:''}${r.admin_note?`<div style="margin-top:8px;padding:8px 12px;background:var(--primary-dim);border-radius:8px;font-size:.75rem"><strong>Note:</strong> ${esc(r.admin_note)}</div>`:''}<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center"><input type="number" id="price-${r.id}" placeholder="Price ($)" value="${r.price||''}" style="width:100px;padding:8px;font-size:.75rem"><input type="text" id="note-${r.id}" placeholder="Admin note..." value="${esc(r.admin_note||'')}" style="flex:1;min-width:150px;padding:8px;font-size:.75rem"><button onclick="updateAppRequest('${r.id}','quoted')" class="btn btn-warn btn-sm">Set Price</button><button onclick="updateAppRequest('${r.id}','approved')" class="btn btn-primary btn-sm">Approve</button><button onclick="updateAppRequest('${r.id}','declined')" class="btn btn-danger btn-sm">Decline</button></div></div>`).join('')}
async function updateAppRequest(id,status){if(!isAdmin())return;const price=document.getElementById('price-'+id)?.value;const admin_note=document.getElementById('note-'+id)?.value||'';const update={status,admin_note};if(price&&!isNaN(price))update.price=parseFloat(price);const{error}=await sb.from('app_requests').update(update).eq('id',id);if(error)return alert("Error: "+error.message);loadAdminAppRequests()}
async function loadAdminTickets(){if(!isAdmin())return;const{data}=await sb.from('tickets').select('*').order('created_at',{ascending:false});const c=document.getElementById('admin-ticket-list');c.innerHTML=!data?.length?`<div class="empty"><div class="empty-icon">ğŸ“‹</div>No tickets</div>`:data.map(t=>ticketCard(t,true)).join('')}
async function updateTicketStatus(id,status){const{error}=await sb.from('tickets').update({status}).eq('id',id);if(error)alert("Error: "+error.message)}
bootstrap();
</script>
</body>
</html>
